<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ß–∞—Ç & –ö–∏–Ω–æ–∑–∞–ª üéÑ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%); min-height: 100vh; overflow-x: hidden; position: relative; }
        
        /* –≠—Ñ—Ñ–µ–∫—Ç—ã —Ñ–æ–Ω–∞ */
        .snowflake { position: fixed; top: -10px; color: #fff; pointer-events: none; z-index: 1; animation: fall linear infinite; font-size: 20px; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }
        .firework-particle { position: fixed; width: 6px; height: 6px; border-radius: 50%; pointer-events: none; z-index: 9999; animation: explode 1s ease-out forwards; }
        @keyframes explode { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity: 0; } }

        .container { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; z-index: 10; }

        /* –¢–∞–π–º–µ—Ä */
        .timer-box { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border-radius: 30px; padding: 20px; margin-bottom: 20px; border: 2px solid rgba(255, 255, 255, 0.2); text-align: center; }
        .timer { display: flex; justify-content: center; gap: 20px; }
        .time-value { font-size: 40px; font-weight: 800; color: #fcd34d; }

        /* –ö–ò–ù–û–ó–ê–õ */
        #cinema-screen { 
            display: none; width: 100%; aspect-ratio: 16/9; background: #000; 
            border-radius: 20px; overflow: hidden; margin-bottom: 20px; 
            border: 2px solid #fcd34d; box-shadow: 0 0 20px rgba(252, 211, 77, 0.5);
        }
        iframe, video { width: 100%; height: 100%; border: none; }

        /* –ß–∞—Ç */
        .chat-container { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border-radius: 30px; border: 2px solid rgba(255, 255, 255, 0.2); overflow: hidden; }
        .chat-header { background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(249, 115, 22, 0.3)); padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .chat-title-main { color: #ffffff !important; font-weight: 900 !important; font-size: 28px; }
        .messages { height: 400px; overflow-y: auto; padding: 20px; background: rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        
        .message { margin-bottom: 15px; display: flex; flex-direction: column; max-width: 80%; }
        .message.own { align-self: flex-end; }
        .message.other { align-self: flex-start; }
        .message-content { padding: 10px 15px; border-radius: 15px; color: white; word-wrap: break-word; }
        .message.own .message-content { background: linear-gradient(135deg, #fbbf24, #f97316); }
        .message.other .message-content { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255,255,255,0.3); }

        .input-area { padding: 20px; display: flex; gap: 10px; }
        input { flex: 1; padding: 15px; border-radius: 15px; border: none; background: rgba(255, 255, 255, 0.2); color: white; outline: none; }
        button.action-btn { padding: 10px 25px; border-radius: 15px; border: none; background: #f59e0b; color: white; font-weight: bold; cursor: pointer; }

        /* –ú–æ–¥–∞–ª–∫–∏ –∏ –ê–¥–º–∏–Ω–∫–∞ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: #1e293b; padding: 25px; border-radius: 30px; width: 95%; max-width: 500px; text-align: center; color: white; }
        .admin-scroll-area { max-height: 250px; overflow-y: auto; text-align: left; margin-bottom: 15px; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 5px; }
        .hidden { display: none !important; }
        
        .cinema-controls { display: flex; gap: 5px; margin-top: 10px; }
        .cinema-input { flex: 1; padding: 8px; border-radius: 8px; border: none; }
    </style>
</head>
<body>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h1 style="color:#fcd34d">üéÑ –ù–û–í–û–ì–û–î–ù–ò–ô –ß–ê–¢</h1>
            <input type="text" id="nickInput" placeholder="–í–∞—à –Ω–∏–∫..." maxlength="15" style="width: 100%; padding: 15px; border-radius: 15px; margin-top: 20px; border: none;">
            <button onclick="joinChat()" class="action-btn" style="width: 100%; margin-top: 15px;">–í–û–ô–¢–ò üéâ</button>
        </div>
    </div>

    <div id="adminModal" class="modal hidden">
        <div class="modal-content">
            <h2>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            
            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                <h3 style="margin:0 0 5px 0;">üé• –ö–∏–Ω–æ–∑–∞–ª</h3>
                <div class="cinema-controls">
                    <input type="text" id="videoUrlInput" class="cinema-input" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ YouTube –∏–ª–∏ MP4...">
                    <button onclick="setCinema()" style="background:#10b981; border:none; border-radius:8px; padding:0 10px; cursor:pointer;">‚ñ∂Ô∏è</button>
                    <button onclick="stopCinema()" style="background:#ef4444; border:none; border-radius:8px; padding:0 10px; cursor:pointer;">‚èπ</button>
                </div>
            </div>

            <div class="admin-scroll-area">
                <div style="color:#fcd34d; font-size:12px; margin: 5px 0;">–ê–ö–¢–ò–í–ù–´–ï (ONLINE)</div>
                <div id="activeUserList"></div>
                <div style="color:#fcd34d; font-size:12px; margin: 10px 0;">–ó–ê–ë–ê–ù–ï–ù–ù–´–ï / –ö–ò–ö–ù–£–¢–´–ï</div>
                <div id="blockedUserList"></div>
            </div>

            <div style="display:flex; gap:10px;">
                <button onclick="adminAction('fireworks')" style="flex:1; background:#8b5cf6; padding:10px; border:none; border-radius:10px; color:white;">üéá –°–∞–ª—é—Ç</button>
                <button onclick="adminAction('clear')" style="flex:1; background:#ef4444; padding:10px; border:none; border-radius:10px; color:white;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <button onclick="closeAdmin()" style="background:#475569; width:100%; padding:10px; border:none; border-radius:10px; color:white; margin-top:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div class="container">
        <div class="timer-box">
            <div id="timerTitle" style="color:white; margin-bottom:10px;">‚è∞ –î–û –ù–û–í–û–ì–û –ì–û–î–ê:</div>
            <div class="timer">
                <div class="time-unit"><div class="time-value" id="h">00</div></div>
                <div class="time-unit"><div class="time-value" id="m">00</div></div>
                <div class="time-unit"><div class="time-value" id="s">00</div></div>
            </div>
        </div>

        <div id="cinema-screen"></div>

        <div class="chat-container">
            <div class="chat-header">
                <h3 class="chat-title-main">–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ß–∞—Ç</h3>
                <div>
                    <button style="background:none; border:none; font-size:24px; cursor:pointer;" onclick="logout()">üö™</button>
                    <button style="background:none; border:none; font-size:24px; cursor:pointer;" onclick="openAdmin()">‚öôÔ∏è</button>
                </div>
            </div>
            <div class="messages" id="chatBox"></div>
            <div class="input-area">
                <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="action-btn" onclick="sendMsg()">üì®</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onChildAdded, remove, onValue, set, serverTimestamp, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDOhC3fadF5gs73HgD3kkeRFE1YGgixgAA",
            authDomain: "new-year-chat.firebaseapp.com",
            databaseURL: "https://new-year-chat-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "new-year-chat",
            storageBucket: "new-year-chat.firebasestorage.app",
            messagingSenderId: "925117697794",
            appId: "1:925117697794:web:4a8a4ce97e343fead07c1b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let myNick = localStorage.getItem('chat_nick');
        const ADMIN_PASS = "2025";

        // --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
        async function enableNotifications() {
            if ("Notification" in window) await Notification.requestPermission();
        }
        function triggerNotify(user, text) {
            if (document.hidden && Notification.permission === "granted") {
                new Notification("üéÑ " + user, { body: text, icon: "https://cdn-icons-png.flaticon.com/512/3893/3893071.png" });
                new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(()=>{});
                if (navigator.vibrate) navigator.vibrate([100]);
            }
        }

        // --- –í–•–û–î –ò –ü–†–û–í–ï–†–ö–ê –û–ù–õ–ê–ô–ù–ê ---
        window.joinChat = () => {
            const nick = document.getElementById('nickInput').value.trim();
            if (!nick) return;
            enableNotifications();
            myNick = nick;
            localStorage.setItem('chat_nick', nick);

            // –°—Å—ã–ª–∫–∞ –Ω–∞ –º–æ–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userRef = ref(db, 'users/' + nick);
            
            // 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
            set(userRef, { lastSeen: serverTimestamp(), kicked: false });
            
            // 2. –í–ê–ñ–ù–û: –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            onDisconnect(userRef).remove(); 

            document.getElementById('loginModal').classList.add('hidden');
            checkStatus();
        };

        function checkStatus() {
            if (!myNick) return;
            onValue(ref(db, 'banned/' + myNick), (snap) => {
                if (snap.exists() && Date.now() < snap.val()) {
                    alert("–í–´ –ó–ê–ë–ê–ù–ï–ù–´! üö´"); logout();
                }
            });
            onValue(ref(db, 'users/' + myNick + '/kicked'), (snap) => {
                if (snap.val() === true) {
                    set(ref(db, 'users/' + myNick + '/kicked'), false); logout();
                }
            });
        }
        window.logout = () => { localStorage.removeItem('chat_nick'); location.reload(); };

        // --- –ö–ò–ù–û–ó–ê–õ ---
        window.setCinema = () => {
            const url = document.getElementById('videoUrlInput').value.trim();
            if(url) set(ref(db, 'cinema/current'), url);
        };
        window.stopCinema = () => remove(ref(db, 'cinema/current'));

        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–µ–æ —É –≤—Å–µ—Ö
        onValue(ref(db, 'cinema/current'), (snap) => {
            const screen = document.getElementById('cinema-screen');
            const url = snap.val();

            if (!url) {
                screen.style.display = 'none';
                screen.innerHTML = '';
            } else {
                screen.style.display = 'block';
                let embedCode = '';

                // –õ–æ–≥–∏–∫–∞ YouTube
                if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    let videoId = '';
                    if (url.includes('v=')) videoId = url.split('v=')[1].split('&')[0];
                    else if (url.includes('youtu.be/')) videoId = url.split('youtu.be/')[1];
                    
                    embedCode = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
                } 
                // –õ–æ–≥–∏–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (mp4)
                else {
                    embedCode = `<video controls autoplay src="${url}"></video>`;
                }
                screen.innerHTML = embedCode;
            }
        });

        // --- –ß–ê–¢ ---
        window.sendMsg = () => {
            const inp = document.getElementById('msgInput');
            if (inp.value.trim() && myNick) {
                push(ref(db, 'messages'), { user: myNick, text: inp.value.trim() });
                inp.value = "";
            }
        };
        document.getElementById('msgInput').addEventListener('keydown', (e) => { if(e.key === 'Enter') sendMsg(); });

        let initLoad = true;
        onChildAdded(ref(db, 'messages'), (snap) => {
            const m = snap.val();
            const div = document.createElement('div');
            div.className = `message ${m.user === myNick ? 'own' : 'other'}`;
            div.innerHTML = `<div style="font-size:10px; color:#ddd; margin-bottom:2px;">${m.user}</div><div class="message-content">${m.text}</div>`;
            document.getElementById('chatBox').appendChild(div);
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
            if (!initLoad && m.user !== myNick) triggerNotify(m.user, m.text);
        });
        setTimeout(() => initLoad = false, 2000);

        // --- –ê–î–ú–ò–ù–ö–ê ---
        window.openAdmin = () => {
            if (localStorage.getItem('admin_access') === ADMIN_PASS || prompt("–ü–∞—Ä–æ–ª—å:") === ADMIN_PASS) {
                localStorage.setItem('admin_access', ADMIN_PASS);
                document.getElementById('adminModal').classList.remove('hidden');
                updateLists();
            }
        };

        function updateLists() {
            onValue(ref(db, '/'), (snap) => {
                const d = snap.val() || {};
                const users = d.users || {};
                const banned = d.banned || {};
                
                const act = document.getElementById('activeUserList');
                const blk = document.getElementById('blockedUserList');
                act.innerHTML = ""; blk.innerHTML = "";

                // –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–∞–Ω-–ª–∏—Å—Ç (–¥–∞–∂–µ –µ—Å–ª–∏ —é–∑–µ—Ä –æ—Ñ–ª–∞–π–Ω)
                Object.keys(banned).forEach(name => {
                     if (Date.now() < banned[name]) {
                        blk.innerHTML += `<div class="user-item"><span>üî¥ ${name}</span><button onclick="unban('${name}')" style="background:#10b981;border:none;color:white;padding:4px;">–†–∞–∑–±–∞–Ω</button></div>`;
                     }
                });

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö (–±–ª–∞–≥–æ–¥–∞—Ä—è onDisconnect —Ç—É—Ç –±—É–¥—É—Ç —Ç–æ–ª—å–∫–æ —Ç–µ, –∫—Ç–æ –æ–Ω–ª–∞–π–Ω)
                Object.keys(users).forEach(name => {
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–Ω–µ, –º—ã –µ–≥–æ —É–∂–µ –ø–æ–∫–∞–∑–∞–ª–∏ –≤ blockedUserList, –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º
                    if (banned[name] && Date.now() < banned[name]) return;
                    
                    act.innerHTML += `<div class="user-item">
                        <span>üü¢ ${name}</span>
                        <div>
                            <button onclick="kick('${name}')" style="background:orange;border:none;color:white;padding:4px;">K</button>
                            <button onclick="banPrompt('${name}')" style="background:red;border:none;color:white;padding:4px;">B</button>
                        </div>
                    </div>`;
                });
            });
        }

        window.kick = (n) => set(ref(db, `users/${n}/kicked`), true);
        window.unban = (n) => { set(ref(db, `users/${n}/kicked`), false); remove(ref(db, `banned/${n}`)); };
        window.banPrompt = (n) => {
            const m = prompt("–ú–∏–Ω—É—Ç:", "10");
            if (m) { set(ref(db, 'banned/' + n), Date.now() + (parseInt(m) * 60000)); kick(n); }
        };
        window.closeAdmin = () => document.getElementById('adminModal').classList.add('hidden');
        window.adminAction = (a) => {
            if (a === 'clear') remove(ref(db, 'messages'));
            if (a === 'fireworks') set(ref(db, 'signal/fire'), Date.now());
        };

        // --- –≠–§–§–ï–ö–¢–´ ---
        onValue(ref(db, 'signal/fire'), (s) => { if(s.val() && !initLoad) fire(); });
        function fire() {
            const x = Math.random()*window.innerWidth, y = Math.random()*window.innerHeight;
            for(let i=0; i<30; i++) {
                const p = document.createElement('div'); p.className='firework-particle';
                p.style.left=x+'px'; p.style.top=y+'px'; p.style.backgroundColor=`hsl(${Math.random()*360},100%,50%)`;
                const a = Math.random()*Math.PI*2, d = Math.random()*150+50;
                p.style.setProperty('--dx', Math.cos(a)*d+'px'); p.style.setProperty('--dy', Math.sin(a)*d+'px');
                document.body.appendChild(p); setTimeout(()=>p.remove(), 1000);
            }
        }
        function createSnow() {
            for(let i=0; i<40; i++){
                const s = document.createElement('div'); s.className='snowflake'; s.innerText='‚ùÑ';
                s.style.left=Math.random()*100+'%'; s.style.animationDuration=(Math.random()*5+5)+'s';
                document.body.appendChild(s);
            }
        }
        setInterval(() => {
            const d = new Date(2026, 0, 1) - new Date();
            if(d > 0) {
                document.getElementById('h').innerText = Math.floor(d/3600000%24).toString().padStart(2,'0');
                document.getElementById('m').innerText = Math.floor(d/60000%60).toString().padStart(2,'0');
                document.getElementById('s').innerText = Math.floor(d/1000%60).toString().padStart(2,'0');
            }
        }, 1000);
        createSnow();
        if(myNick) { document.getElementById('loginModal').classList.add('hidden'); checkStatus(); }
    </script>
</body>
</html>

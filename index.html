<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä Pro üéÑ</title>
    <script src="https://www.youtube.com/iframe_api"></script> <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%); min-height: 100vh; overflow-x: hidden; color: white; }
        
        .snowflake { position: fixed; top: -10px; color: #fff; pointer-events: none; z-index: 1; animation: fall linear infinite; font-size: 20px; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }

        .container { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; z-index: 10; }

        /* --- –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ü–õ–ï–ï–† --- */
        .cinema-container {
            background: #000; border: 2px solid #fcd34d; border-radius: 20px;
            overflow: hidden; margin-bottom: 20px; position: relative;
            box-shadow: 0 0 30px rgba(252, 211, 77, 0.3); display: none;
            aspect-ratio: 16/9; /* –§–∏–∫—Å–∏—Ä—É–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ */
        }
        
        /* –°–ª–æ–π –¥–ª—è YouTube –∏ MP4 */
        #youtube-player-placeholder, #html5-player { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        #html5-player { object-fit: contain; }

        /* –ü–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–π —Å–ª–æ–π (—á—Ç–æ–±—ã –æ–±—ã—á–Ω—ã–µ —é–∑–µ—Ä—ã –Ω–µ —Ç—ã–∫–∞–ª–∏ –ø–∞—É–∑—É —Å–∞–º–∏) */
        .blocker-layer { position: absolute; inset: 0; z-index: 10; background: transparent; }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–¢–æ–ª—å–∫–æ –ê–¥–º–∏–Ω) */
        .controls-layer {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 20;
            background: rgba(0, 0, 0, 0.8); padding: 10px; display: flex; align-items: center; gap: 10px;
        }
        .control-btn { background: none; border: none; color: #fcd34d; font-size: 24px; cursor: pointer; padding: 0 10px; }
        .progress-bar { flex: 1; cursor: pointer; height: 5px; }
        .time-display { font-size: 14px; font-family: monospace; min-width: 100px; text-align: center; }

        /* –ß–∞—Ç */
        .chat-container { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border-radius: 30px; border: 2px solid rgba(255, 255, 255, 0.2); overflow: hidden; height: 500px; display: flex; flex-direction: column; }
        .chat-header { padding: 15px; background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .message { margin-bottom: 10px; max-width: 80%; padding: 8px 12px; border-radius: 15px; font-size: 14px; }
        .message.own { align-self: flex-end; background: linear-gradient(135deg, #fbbf24, #f97316); }
        .message.other { align-self: flex-start; background: rgba(255,255,255,0.2); }
        .input-area { padding: 15px; display: flex; gap: 10px; background: rgba(0,0,0,0.2); }
        input { flex: 1; padding: 10px; border-radius: 10px; border: none; background: rgba(255,255,255,0.2); color: white; outline: none; }
        
        /* –ú–æ–¥–∞–ª–∫–∏ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #555; }
        .hidden { display: none !important; }
        .user-item { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #333; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2 style="color:#fcd34d">üéÑ –ö–ò–ù–û-–ß–ê–¢</h2>
            <input type="text" id="nickInput" placeholder="–ù–∏–∫–Ω–µ–π–º..." style="width:100%; margin:20px 0; padding:10px;">
            <button onclick="joinChat()" style="width:100%; padding:10px; background:#f59e0b; border:none; border-radius:5px; cursor:pointer;">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div id="adminModal" class="modal hidden">
        <div class="modal-content">
            <h3>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <div style="background:#333; padding:10px; border-radius:10px; margin:15px 0;">
                <p>üé¨ <b>–°—Å—ã–ª–∫–∞ (YouTube –∏–ª–∏ .mp4):</b></p>
                <input type="text" id="mediaUrl" placeholder="https://youtube.com/watch?v=..." style="width:100%; margin-bottom:10px; padding:5px;">
                <button onclick="startMedia()" style="background:#10b981; border:none; padding:8px 20px; color:white; border-radius:5px; cursor:pointer;">‚ñ∂Ô∏è –ó–ê–ü–£–°–¢–ò–¢–¨</button>
                <button onclick="stopMedia()" style="background:#ef4444; border:none; padding:8px 20px; color:white; border-radius:5px; cursor:pointer; margin-top:5px;">‚èπ –°–¢–û–ü</button>
            </div>
            <div id="userList" style="text-align:left; margin-bottom:15px;"></div>
            <button onclick="closeAdmin()" style="width:100%; padding:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div class="container">
        <div id="cinema" class="cinema-container">
            <video id="html5-player" class="hidden"></video>
            <div id="youtube-player-placeholder"></div>
            
            <div id="clickBlocker" class="blocker-layer"></div>

            <div id="adminControls" class="controls-layer hidden">
                <button id="btnPlay" class="control-btn">‚ñ∂</button>
                <button id="btnPause" class="control-btn hidden">‚è∏</button>
                <input type="range" id="progressBar" class="progress-bar" min="0" value="0" step="1">
                <span id="timeDisplay" class="time-display">00:00 / 00:00</span>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <h3>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ß–∞—Ç</h3>
                <div>
                    <button onclick="logout()" style="background:none; border:none; font-size:20px; cursor:pointer;">üö™</button>
                    <button onclick="openAdmin()" style="background:none; border:none; font-size:20px; cursor:pointer;">‚öôÔ∏è</button>
                </div>
            </div>
            <div class="messages" id="chatBox"></div>
            <div class="input-area">
                <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button onclick="sendMsg()" style="padding:10px 20px; border:none; background:#fcd34d; border-radius:10px; cursor:pointer;">üì®</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onChildAdded, remove, onValue, set, serverTimestamp, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDOhC3fadF5gs73HgD3kkeRFE1YGgixgAA",
            authDomain: "new-year-chat.firebaseapp.com",
            databaseURL: "https://new-year-chat-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "new-year-chat",
            storageBucket: "new-year-chat.firebasestorage.app",
            messagingSenderId: "925117697794",
            appId: "1:925117697794:web:4a8a4ce97e343fead07c1b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let myNick = localStorage.getItem('chat_nick');
        const ADMIN_PASS = "2025";
        let isAdmin = localStorage.getItem('admin_access') === ADMIN_PASS;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–ª–µ–µ—Ä–æ–≤
        let ytPlayer = null;
        let html5Player = document.getElementById('html5-player');
        let currentMode = null; // 'youtube' or 'html5'
        let duration = 0;

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø YOUTUBE API ---
        window.onYouTubeIframeAPIReady = function() {
            ytPlayer = new YT.Player('youtube-player-placeholder', {
                height: '100%', width: '100%',
                playerVars: { 'controls': 0, 'rel': 0, 'showinfo': 0, 'modestbranding': 1 },
                events: {
                    'onReady': onPlayerReady
                }
            });
        };

        function onPlayerReady(event) {
            // –ü–ª–µ–µ—Ä –≥–æ—Ç–æ–≤
        }

        // --- –õ–û–ì–ò–ö–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ---
        const cinemaBox = document.getElementById('cinema');
        const adminControls = document.getElementById('adminControls');
        const blocker = document.getElementById('clickBlocker');
        const btnPlay = document.getElementById('btnPlay');
        const btnPause = document.getElementById('btnPause');
        const progressBar = document.getElementById('progressBar');
        const timeDisplay = document.getElementById('timeDisplay');

        // –°–ª—É—à–∞–µ–º Firebase
        onValue(ref(db, 'cinema/state'), (snap) => {
            const data = snap.val();
            
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å—ë
            if (!data) {
                cinemaBox.style.display = 'none';
                if(ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo();
                html5Player.pause();
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            if (cinemaBox.style.display === 'none') cinemaBox.style.display = 'block';

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤
            if (data.type === 'youtube') {
                html5Player.classList.add('hidden');
                // –ï—Å–ª–∏ —é—Ç—É–± –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª –≤–∏–¥–µ–æ –∏–ª–∏ —ç—Ç–æ –Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ
                if (ytPlayer && ytPlayer.cueVideoById) {
                     // –ü–æ–ª—É—á–∞–µ–º ID –∏–∑ URL –∏–ª–∏ –¥–∞–Ω–Ω—ã—Ö
                     // –ó–¥–µ—Å—å –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –≤ data.src –ª–µ–∂–∏—Ç ID –≤–∏–¥–µ–æ –¥–ª—è —é—Ç—É–±–∞
                     let currentData = ytPlayer.getVideoData();
                     if (!currentData || currentData.video_id !== data.src) {
                         ytPlayer.loadVideoById(data.src);
                     }
                }
                currentMode = 'youtube';
            } else {
                // HTML5 Mode
                if (html5Player.src !== data.src) html5Player.src = data.src;
                html5Player.classList.remove('hidden');
                currentMode = 'html5';
            }

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è (Play/Pause/Time)
            syncPlayer(data);

            // UI –ê–¥–º–∏–Ω–∞
            if (isAdmin) {
                adminControls.classList.remove('hidden');
                blocker.style.pointerEvents = 'none'; // –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –∫–ª–∏–∫–∞—Ç—å
                updateControlsUI(data.status);
            } else {
                adminControls.classList.add('hidden');
                blocker.style.pointerEvents = 'all'; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –æ–±—ã—á–Ω—ã–º
            }
        });

        function syncPlayer(data) {
            let currentTime = 0;
            
            if (currentMode === 'youtube' && ytPlayer && ytPlayer.seekTo) {
                currentTime = ytPlayer.getCurrentTime();
                // –ï—Å–ª–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω > 2 —Å–µ–∫
                if (Math.abs(currentTime - data.time) > 2) ytPlayer.seekTo(data.time);
                
                if (data.status === 'playing' && ytPlayer.getPlayerState() !== 1) ytPlayer.playVideo();
                if (data.status === 'paused' && ytPlayer.getPlayerState() === 1) ytPlayer.pauseVideo();
                
            } else if (currentMode === 'html5') {
                currentTime = html5Player.currentTime;
                if (Math.abs(currentTime - data.time) > 2) html5Player.currentTime = data.time;
                
                if (data.status === 'playing' && html5Player.paused) html5Player.play().catch(()=>{});
                if (data.status === 'paused' && !html5Player.paused) html5Player.pause();
            }
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ê–î–ú–ò–ù–ê ---
        function getMyTime() {
            if (currentMode === 'youtube' && ytPlayer) return ytPlayer.getCurrentTime();
            if (currentMode === 'html5') return html5Player.currentTime;
            return 0;
        }
        
        function getMyDuration() {
            if (currentMode === 'youtube' && ytPlayer) return ytPlayer.getDuration();
            if (currentMode === 'html5') return html5Player.duration;
            return 100;
        }

        function updateFirebase(status, timeOverride = null) {
            const time = timeOverride !== null ? timeOverride : getMyTime();
            const src = currentMode === 'youtube' ? ytPlayer.getVideoData().video_id : html5Player.src;
            
            set(ref(db, 'cinema/state'), {
                type: currentMode,
                src: src, // –î–ª—è —é—Ç—É–±–∞ —ç—Ç–æ ID, –¥–ª—è —Ñ–∞–π–ª–∞ URL
                status: status,
                time: time,
                timestamp: Date.now()
            });
        }

        if (isAdmin) {
            btnPlay.onclick = () => updateFirebase('playing');
            btnPause.onclick = () => updateFirebase('paused');
            
            progressBar.oninput = () => {
                updateFirebase('paused', parseFloat(progressBar.value));
            };

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∑—É–Ω–∫–∞ –∞–¥–º–∏–Ω–∞
            setInterval(() => {
                if (currentMode) {
                    const t = getMyTime();
                    const d = getMyDuration();
                    progressBar.max = d;
                    progressBar.value = t;
                    timeDisplay.innerText = formatTime(t) + " / " + formatTime(d);
                }
            }, 1000);
        }
        
        function formatTime(s) {
            s = Math.floor(s);
            let m = Math.floor(s / 60);
            let sec = s % 60;
            return `${m}:${sec<10?'0'+sec:sec}`;
        }

        // --- –ó–ê–ü–£–°–ö –í–ò–î–ï–û (–ü–ê–†–°–ï–†) ---
        window.startMedia = () => {
            const url = document.getElementById('mediaUrl').value.trim();
            if (!url) return;
            
            let type = 'html5';
            let src = url;

            // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ YouTube
            const ytRegExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(ytRegExp);

            if (match && match[2].length === 11) {
                type = 'youtube';
                src = match[2]; // ID –í–∏–¥–µ–æ
            }

            set(ref(db, 'cinema/state'), {
                type: type,
                src: src,
                status: 'paused', // –°—Ç–∞—Ä—Ç –Ω–∞ –ø–∞—É–∑–µ
                time: 0,
                timestamp: Date.now()
            });
            
            // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
            document.getElementById('adminModal').classList.add('hidden');
        };
        
        window.stopMedia = () => remove(ref(db, 'cinema/state'));


        // --- –û–ë–´–ß–ù–´–ô –ß–ê–¢ ---
        window.joinChat = () => {
            const nick = document.getElementById('nickInput').value.trim();
            if (!nick) return;
            myNick = nick;
            localStorage.setItem('chat_nick', nick);
            
            const userRef = ref(db, 'users/' + nick);
            set(userRef, { online: true });
            onDisconnect(userRef).remove();

            document.getElementById('loginModal').classList.add('hidden');
            if (localStorage.getItem('admin_access') === ADMIN_PASS) {
                isAdmin = true;
                adminControls.classList.remove('hidden');
            }
        };

        window.sendMsg = () => {
            const i = document.getElementById('msgInput');
            if(i.value.trim()) {
                push(ref(db, 'messages'), { user: myNick, text: i.value.trim() });
                i.value = '';
            }
        };
        onChildAdded(ref(db, 'messages'), (s) => {
            const m = s.val();
            const d = document.createElement('div');
            d.className = `message ${m.user === myNick ? 'own' : 'other'}`;
            d.innerText = `${m.user}: ${m.text}`;
            document.getElementById('chatBox').appendChild(d);
            document.getElementById('chatBox').scrollTop = 9999;
        });

        window.logout = () => { localStorage.removeItem('chat_nick'); location.reload(); };
        window.openAdmin = () => {
            if (localStorage.getItem('admin_access') === ADMIN_PASS || prompt("–ü–∞—Ä–æ–ª—å:") === ADMIN_PASS) {
                localStorage.setItem('admin_access', ADMIN_PASS);
                isAdmin = true;
                document.getElementById('adminModal').classList.remove('hidden');
                loadUsers();
            }
        };
        window.closeAdmin = () => document.getElementById('adminModal').classList.add('hidden');
        
        function loadUsers() {
             onValue(ref(db, 'users'), (snap) => {
                const div = document.getElementById('userList');
                div.innerHTML = '';
                snap.forEach(u => div.innerHTML += `<div class="user-item"><span>üü¢ ${u.key}</span><button onclick="kick('${u.key}')" style="background:red;border:none;color:white;">Kick</button></div>`);
            });
        }
        window.kick = (n) => set(ref(db, `users/${n}/kicked`), true);

        // –°–Ω–µ–≥
        function createSnow() {
            for(let i=0; i<30; i++){
                const s = document.createElement('div'); s.className='snowflake'; s.innerText='‚ùÑ';
                s.style.left=Math.random()*100+'%'; s.style.animationDuration=(Math.random()*5+5)+'s';
                document.body.appendChild(s);
            }
        }
        createSnow();
        if(myNick) { document.getElementById('loginModal').classList.add('hidden'); }
    </script>
</body>
</html>

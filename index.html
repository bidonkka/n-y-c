<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ß–∞—Ç Pro üéÑ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            min-height: 100vh; overflow-x: hidden; position: relative;
        }

        /* --- –°–Ω–µ–∂–∏–Ω–∫–∏ (–í–µ—Ä–Ω—É–ª —ç–º–æ–¥–∑–∏) --- */
        .snowflake { 
            position: fixed; top: -10px; color: #fff; pointer-events: none; z-index: 1; 
            animation: fall linear infinite; font-size: 20px;
        }
        @keyframes fall { 
            to { transform: translateY(100vh) rotate(360deg); } 
        }

        /* --- –°–∞–ª—é—Ç –Ω–∞ CSS (–ë–µ–∑ —Å–∏–º–≤–æ–ª–æ–≤, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∫–≤–∞–¥—Ä–∞—Ç–æ–≤) --- */
        .firework-particle {
            position: fixed; width: 6px; height: 6px; border-radius: 50%;
            pointer-events: none; z-index: 9999;
            animation: explode 1s ease-out forwards;
        }
        @keyframes explode {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity: 0; }
        }

        .container { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; z-index: 10; }

        .timer-box {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px);
            border-radius: 30px; padding: 30px; margin-bottom: 20px; border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); text-align: center;
        }
        .timer-title { color: white; font-size: 28px; font-weight: bold; margin-bottom: 20px; }
        .timer { display: flex; justify-content: center; gap: 20px; }
        .time-unit { background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(250, 204, 21, 0.5); border-radius: 20px; padding: 20px; min-width: 90px; }
        .time-value { font-size: 48px; font-weight: 800; color: #fcd34d; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
        .time-label { color: rgba(255, 255, 255, 0.8); font-size: 14px; margin-top: 5px; }

        .chat-container {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px);
            border-radius: 30px; border: 2px solid rgba(255, 255, 255, 0.2); overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .chat-header {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(249, 115, 22, 0.3));
            padding: 20px; border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ –ø—Ä–æ—Å—å–±–µ: –ë–µ–ª—ã–π –∏ –∂–∏—Ä–Ω—ã–π */
        .chat-title-main { 
            color: #ffffff !important; 
            font-weight: 900 !important; 
            font-size: 28px; 
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .messages { height: 400px; overflow-y: auto; padding: 20px; background: rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        .message { margin-bottom: 15px; display: flex; flex-direction: column; max-width: 75%; animation: slideIn 0.3s ease-out; position: relative; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } }
        .message.own { align-self: flex-end; }
        .message.other { align-self: flex-start; }
        
        .message-content { padding: 12px 16px; border-radius: 20px; cursor: pointer; position: relative; }
        .message.own .message-content { background: linear-gradient(135deg, #fbbf24, #f97316); color: white; }
        .message.other .message-content { background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.3); color: white; }
        
        .message-user { font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #fff; }
        .message.own .message-user { text-align: right; }

        .like-badge {
            position: absolute; bottom: -10px; right: -5px; background: white; color: #ef4444;
            padding: 2px 6px; border-radius: 10px; font-size: 12px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .input-area { padding: 20px; background: rgba(255, 255, 255, 0.05); display: flex; gap: 10px; }
        input { flex: 1; padding: 15px; border-radius: 15px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.2); color: white; outline: none; }
        button.action-btn { padding: 10px 25px; border-radius: 15px; border: none; background: #f59e0b; color: white; font-weight: bold; cursor: pointer; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 30px; width: 90%; max-width: 400px; text-align: center; color: white; border: 1px solid #475569; }
        .hidden { display: none !important; }

        .user-list { max-height: 250px; overflow-y: auto; margin: 20px 0; background: rgba(0,0,0,0.3); border-radius: 15px; padding: 10px; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .admin-controls button { padding: 6px 12px; margin: 5px; border-radius: 8px; border: none; color: white; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h1 style="color:#fcd34d">üéÑ –° –ù–û–í–´–ú –ì–û–î–û–ú!</h1>
            <p style="margin: 15px 0;">–í–≤–µ–¥–∏ –Ω–∏–∫, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏</p>
            <input type="text" id="nickInput" placeholder="–ù–∏–∫–Ω–µ–π–º..." maxlength="15" style="width: 100%;">
            <button onclick="joinChat()" class="action-btn" style="width: 100%; margin-top: 15px;">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div id="adminModal" class="modal hidden">
        <div class="modal-content">
            <h2>‚öôÔ∏è –ê–¥–º–∏–Ω-–ü–∞–Ω–µ–ª—å</h2>
            <div class="user-list" id="userList"></div>
            <div class="admin-controls">
                <button onclick="adminAction('santa')" style="background: #10b981;">üéÖ –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
                <button onclick="adminAction('fireworks')" style="background: #8b5cf6;">üéÜ –ó–∞–ø—É—Å–∫ —Å–∞–ª—é—Ç–∞</button>
                <button onclick="adminAction('clear')" style="background: #ef4444; width: 90%;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
            </div>
            <button onclick="closeAdmin()" style="background: #475569; margin-top: 15px; width: 100%; border-radius:10px; border:none; padding:10px; color:white;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div class="container">
        <div class="timer-box">
            <div class="timer-title" id="timerTitle">‚è∞ –î–û –ù–û–í–û–ì–û –ì–û–î–ê:</div>
            <div class="timer">
                <div class="time-unit"><div class="time-value" id="h">00</div><div class="time-label">—á–∞—Å–æ–≤</div></div>
                <div class="time-unit"><div class="time-value" id="m">00</div><div class="time-label">–º–∏–Ω—É—Ç</div></div>
                <div class="time-unit"><div class="time-value" id="s">00</div><div class="time-label">—Å–µ–∫—É–Ω–¥</div></div>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <div>
                    <h3 class="chat-title-main">–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ß–∞—Ç</h3>
                    <p style="font-size: 12px; color: rgba(255,255,255,0.7);" id="statusSub">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
                <div>
                    <button style="background:none; border:none; font-size:24px; cursor:pointer;" onclick="logout()" title="–í—ã–π—Ç–∏">üö™</button>
                    <button style="background:none; border:none; font-size:24px; cursor:pointer;" onclick="openAdmin()" title="–ê–¥–º–∏–Ω">‚öôÔ∏è</button>
                </div>
            </div>
            <div class="messages" id="chatBox"></div>
            <div class="input-area">
                <input type="text" id="msgInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="action-btn" onclick="sendMsg()">üì®</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onChildAdded, onChildChanged, remove, onValue, set, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDOhC3fadF5gs73HgD3kkeRFE1YGgixgAA",
            authDomain: "new-year-chat.firebaseapp.com",
            databaseURL: "https://new-year-chat-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "new-year-chat",
            storageBucket: "new-year-chat.firebasestorage.app",
            messagingSenderId: "925117697794",
            appId: "1:925117697794:web:4a8a4ce97e343fead07c1b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let myNick = localStorage.getItem('chat_nick');
        const ADMIN_PASS = "2025";

        // --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
        function requestNotify() {
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }

        function showNotify(user, text) {
            if (document.visibilityState !== "visible" && Notification.permission === "granted") {
                new Notification("üéÑ " + user, { body: text });
                // –ó–≤—É–∫ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
                audio.play().catch(()=>{});
            }
        }

        // --- –ë–ê–ù / –ö–ò–ö ---
        function checkStatus() {
            if (!myNick) return;
            onValue(ref(db, 'banned/' + myNick), (snap) => {
                if (snap.exists() && Date.now() < snap.val()) {
                    alert("–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –¥–æ " + new Date(snap.val()).toLocaleTimeString());
                    logout();
                }
            });
            onValue(ref(db, 'users/' + myNick + '/kicked'), (snap) => {
                if (snap.val() === true) {
                    set(ref(db, 'users/' + myNick + '/kicked'), false);
                    logout();
                }
            });
        }

        window.joinChat = () => {
            const nick = document.getElementById('nickInput').value.trim();
            if (!nick) return;
            requestNotify();
            myNick = nick;
            localStorage.setItem('chat_nick', nick);
            set(ref(db, 'users/' + nick), { lastSeen: serverTimestamp(), kicked: false });
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('statusSub').innerText = "–ü—Ä–∏–≤–µ—Ç, " + myNick;
            checkStatus();
        };

        window.logout = () => {
            localStorage.removeItem('chat_nick');
            location.reload();
        };

        // --- –ß–ê–¢ ---
        window.sendMsg = () => {
            const inp = document.getElementById('msgInput');
            if (inp.value.trim() && myNick) {
                push(ref(db, 'messages'), { user: myNick, text: inp.value.trim(), time: serverTimestamp(), likes: 0 });
                inp.value = "";
            }
        };

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω Enter
        document.getElementById('msgInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMsg();
        });

        onChildAdded(ref(db, 'messages'), (snap) => {
            const m = snap.val();
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `message ${m.user === myNick ? 'own' : 'other'}`;
            div.id = "m-" + snap.key;
            
            const likes = m.likes || 0;
            const likeBadge = likes > 0 ? `<div class="like-badge">‚ù§Ô∏è ${likes}</div>` : "";

            div.innerHTML = `
                <div class="message-user">${m.user}</div>
                <div class="message-content" ondblclick="addLike('${snap.key}')">
                    ${m.text}
                    ${likeBadge}
                </div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            if (m.user !== myNick) showNotify(m.user, m.text);
        });

        window.addLike = (key) => {
            const r = ref(db, `messages/${key}/likes`);
            onValue(r, (s) => set(r, (s.val() || 0) + 1), { onlyOnce: true });
        };

        onChildChanged(ref(db, 'messages'), (snap) => {
            const el = document.getElementById("m-" + snap.key);
            if (el) {
                const likes = snap.val().likes || 0;
                let badge = el.querySelector('.like-badge');
                if (likes > 0) {
                    if (!badge) el.querySelector('.message-content').insertAdjacentHTML('beforeend', `<div class="like-badge">‚ù§Ô∏è ${likes}</div>`);
                    else badge.innerText = "‚ù§Ô∏è " + likes;
                }
            }
        });

        // --- –ê–î–ú–ò–ù–ö–ê ---
        window.openAdmin = () => {
            let saved = localStorage.getItem('admin_access');
            if (saved === ADMIN_PASS || prompt("–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞:") === ADMIN_PASS) {
                localStorage.setItem('admin_access', ADMIN_PASS);
                document.getElementById('adminModal').classList.remove('hidden');
                loadUserList();
            }
        };

        window.closeAdmin = () => document.getElementById('adminModal').classList.add('hidden');

        function loadUserList() {
            onValue(ref(db, 'users'), (snap) => {
                const list = document.getElementById('userList');
                list.innerHTML = "";
                snap.forEach(c => {
                    const name = c.key;
                    list.innerHTML += `<div class="user-item">
                        <span>${name}</span>
                        <div class="admin-controls">
                            <button onclick="kick('${name}')" style="background:orange;">Kick</button>
                            <button onclick="banPrompt('${name}')" style="background:red;">Ban</button>
                        </div>
                    </div>`;
                });
            });
        }

        window.kick = (name) => set(ref(db, `users/${name}/kicked`), true);
        window.banPrompt = (name) => {
            const m = prompt("–ù–∞ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∑–∞–±–∞–Ω–∏—Ç—å " + name + "?", "10");
            if (m) {
                set(ref(db, 'banned/' + name), Date.now() + (parseInt(m) * 60000));
                kick(name);
            }
        };

        window.adminAction = (a) => {
            if (a === 'clear') remove(ref(db, 'messages'));
            if (a === 'fireworks') set(ref(db, 'signal/fire'), Date.now());
            if (a === 'santa') {
                const t = prompt("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ú–æ—Ä–æ–∑–∞:");
                if (t) push(ref(db, 'messages'), { user: "üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑", text: t, time: serverTimestamp() });
            }
        };

        // –°–ª—É—à–∞—Ç–µ–ª—å —Å–∞–ª—é—Ç–∞
        let initSignal = true;
        onValue(ref(db, 'signal/fire'), (snap) => {
            if (!initSignal) createCSSFirework();
            initSignal = false;
        });

        // --- –≠–§–§–ï–ö–¢–´ ---
        function createSnow() {
            for(let i=0; i<40; i++){
                const s = document.createElement('div'); 
                s.className='snowflake'; s.innerText='‚ùÑ';
                s.style.left=Math.random()*100+'%'; 
                s.style.fontSize=Math.random()*10+10+'px';
                s.style.animationDuration=(Math.random()*5+5)+'s';
                s.style.opacity = Math.random();
                document.body.appendChild(s);
            }
        }

        // –ü–û–õ–ù–û–°–¢–¨–Æ –ù–û–í–´–ô –°–ê–õ–Æ–¢ –ù–ê CSS (–ë–ï–ó –ö–í–ê–î–†–ê–¢–û–í)
        function createCSSFirework() {
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight;
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#ffffff'];
            
            for(let i=0; i<30; i++) {
                const p = document.createElement('div');
                p.className = 'firework-particle';
                p.style.left = x + 'px';
                p.style.top = y + 'px';
                p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 150 + 50;
                p.style.setProperty('--dx', Math.cos(angle) * dist + 'px');
                p.style.setProperty('--dy', Math.sin(angle) * dist + 'px');
                
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 1000);
            }
        }

        function timer() {
            const diff = new Date(2026, 0, 1) - new Date();
            if(diff <= 0) { 
                document.getElementById('timerTitle').innerText="üéä –° –ù–û–í–´–ú –ì–û–î–û–ú! üéä"; 
                if (Math.random() > 0.95) createCSSFirework();
                return; 
            }
            document.getElementById('h').innerText = Math.floor(diff/3600000%24).toString().padStart(2,'0');
            document.getElementById('m').innerText = Math.floor(diff/60000%60).toString().padStart(2,'0');
            document.getElementById('s').innerText = Math.floor(diff/1000%60).toString().padStart(2,'0');
        }

        createSnow();
        setInterval(timer, 1000);
        if (myNick) {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('statusSub').innerText = "–ü—Ä–∏–≤–µ—Ç, " + myNick;
            checkStatus();
        }
    </script>
</body>
</html>

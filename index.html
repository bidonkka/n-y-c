<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä 2025 üéÑ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            color: white; 
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        .snowflake {
            position: fixed; top: -10px; color: white; font-size: 1em;
            pointer-events: none; z-index: 1;
            animation: fall linear infinite;
        }
        @keyframes fall { to { transform: translateY(100vh); } }

        .container { max-width: 1000px; margin: 0 auto; padding: 20px; position: relative; z-index: 10; }

        /* –¢–ê–ô–ú–ï–† */
        .timer-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .timer-title {
            text-align: center; color: white; font-size: 24px;
            font-weight: bold; margin-bottom: 15px;
        }
        .timer {
            display: flex; justify-content: center; gap: 15px;
        }
        .time-unit {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(250, 204, 21, 0.5);
            border-radius: 15px; padding: 15px;
            min-width: 80px; text-align: center;
        }
        .time-value {
            font-size: 36px; font-weight: bold;
            color: #fcd34d; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .time-label {
            color: rgba(255, 255, 255, 0.8); font-size: 12px; margin-top: 5px;
        }

        /* –ü–õ–ï–ï–† */
        .cinema-wrapper {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            border: 2px solid #fcd34d;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
            aspect-ratio: 16/9;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: none;
        }
        .cinema-wrapper.active { display: block; }
        
        #videoFrame {
            width: 100%; height: 100%;
            border: none; display: block;
        }

        .video-overlay {
            position: absolute; inset: 0; z-index: 100;
            background: rgba(0, 0, 0, 0.9);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 15px;
        }
        .video-overlay.hidden { display: none; }

        /* –ß–ê–¢ */
        .chat-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .chat-header {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(249, 115, 22, 0.3));
            padding: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-title { font-size: 18px; font-weight: bold; }
        
        #chatBox {
            height: 350px; overflow-y: auto; padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            display: flex; flex-direction: column; gap: 10px;
        }
        #chatBox::-webkit-scrollbar { width: 6px; }
        #chatBox::-webkit-scrollbar-thumb { background: #fbbf24; border-radius: 10px; }

        .msg {
            padding: 10px 14px; border-radius: 12px;
            max-width: 70%; font-size: 14px; line-height: 1.4;
            animation: msgIn 0.2s ease;
        }
        @keyframes msgIn { from { opacity: 0; transform: translateY(5px); } }
        .msg.own { align-self: flex-end; background: #f59e0b; color: black; }
        .msg.other { align-self: flex-start; background: rgba(255,255,255,0.2); }
        .msg-user { font-size: 11px; opacity: 0.7; margin-bottom: 3px; }

        .input-box {
            padding: 15px; display: flex; gap: 10px;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
        }
        input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; padding: 12px; border-radius: 10px;
            flex: 1; outline: none; font-size: 14px;
        }
        input::placeholder { color: rgba(255, 255, 255, 0.5); }
        
        .btn {
            background: linear-gradient(135deg, #fbbf24, #f97316);
            color: white; border: none; padding: 12px 20px;
            border-radius: 10px; cursor: pointer; font-weight: bold;
            transition: transform 0.2s;
        }
        .btn:hover { transform: scale(1.05); }
        .btn:active { transform: scale(0.95); }

        /* –ú–û–î–ê–õ–ö–ò */
        .modal {
            position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }
        .modal.hidden { display: none; }
        
        .modal-inner {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px; border-radius: 20px;
            width: 100%; max-width: 400px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .modal-title {
            font-size: 28px; margin-bottom: 20px; font-weight: bold;
        }

        .admin-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px; border-radius: 10px;
            margin: 15px 0; text-align: left;
        }
        .user-tag {
            background: rgba(16, 185, 129, 0.3);
            color: #10b981; padding: 4px 10px;
            border-radius: 8px; font-size: 12px;
            margin: 5px; display: inline-block;
        }

        .status-indicator {
            display: inline-block; width: 8px; height: 8px;
            background: #10b981; border-radius: 50%;
            margin-right: 5px; animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –≤—Ö–æ–¥–∞ -->
    <div id="loginModal" class="modal">
        <div class="modal-inner">
            <div class="modal-title">üéâ –° –ù–æ–≤—ã–º –ì–æ–¥–æ–º!</div>
            <p style="margin-bottom:15px; opacity:0.8">–í–≤–µ–¥–∏ —Å–≤–æ—ë –∏–º—è</p>
            <input type="text" id="nickInput" placeholder="–¢–≤–æ–π –Ω–∏–∫..." maxlength="15">
            <button class="btn" onclick="join()" style="width:100%; margin-top:15px">–í–û–ô–¢–ò üéÑ</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –∞–¥–º–∏–Ω–∞ -->
    <div id="adminModal" class="modal hidden">
        <div class="modal-inner" style="max-width:500px">
            <div class="modal-title">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä–æ–º</div>
            
            <div class="admin-section">
                <p style="margin-bottom:10px; font-weight:bold">–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ:</p>
                <input type="text" id="videoUrl" placeholder="–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É YouTube..." style="width:100%; margin-bottom:10px">
                <div style="display:flex; gap:10px">
                    <button class="btn" onclick="startVideo()" style="flex:1; background:#10b981">‚ñ∂ –°–¢–ê–†–¢</button>
                    <button class="btn" onclick="stopVideo()" style="flex:1; background:#ef4444">‚ñ† –°–¢–û–ü</button>
                </div>
            </div>

            <div class="admin-section">
                <p style="font-weight:bold; margin-bottom:10px">
                    <span class="status-indicator"></span>–°–µ–π—á–∞—Å –≤ —Å–µ—Ç–∏:
                </p>
                <div id="onlineList"></div>
            </div>

            <button class="btn" onclick="closeAdmin()" style="width:100%; background:#475569">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <div class="container">
        <!-- –¢–ê–ô–ú–ï–† -->
        <div class="timer-box">
            <div class="timer-title" id="timerTitle">‚è∞ –î–æ –ù–æ–≤–æ–≥–æ –ì–æ–¥–∞:</div>
            <div class="timer" id="timer">
                <div class="time-unit">
                    <div class="time-value" id="hours">00</div>
                    <div class="time-label">—á–∞—Å–æ–≤</div>
                </div>
                <div class="time-unit">
                    <div class="time-value" id="minutes">00</div>
                    <div class="time-label">–º–∏–Ω—É—Ç</div>
                </div>
                <div class="time-unit">
                    <div class="time-value" id="seconds">00</div>
                    <div class="time-label">—Å–µ–∫—É–Ω–¥</div>
                </div>
            </div>
        </div>

        <!-- –ü–õ–ï–ï–† -->
        <div id="cinema" class="cinema-wrapper">
            <iframe id="videoFrame" allow="autoplay; fullscreen"></iframe>
            <div id="videoOverlay" class="video-overlay">
                <p style="font-size:18px">üé¨ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ</p>
                <p style="opacity:0.7; margin-bottom:10px">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Å—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                <button class="btn" onclick="syncVideo()">–°–ú–û–¢–†–ï–¢–¨ –í–ú–ï–°–¢–ï üçø</button>
            </div>
        </div>

        <!-- –ß–ê–¢ -->
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-title">üí¨ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ß–∞—Ç</div>
                <button onclick="openAdmin()" style="background:none; border:none; color:#fcd34d; cursor:pointer; font-size:14px">
                    ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
            </div>
            <div id="chatBox"></div>
            <div class="input-box">
                <input type="text" id="msgInput" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button onclick="sendMsg()" class="btn">üì®</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onChildAdded, remove, onValue, set, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDOhC3fadF5gs73HgD3kkeRFE1YGgixgAA",
            authDomain: "new-year-chat.firebaseapp.com",
            databaseURL: "https://new-year-chat-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "new-year-chat",
            storageBucket: "new-year-chat.firebasestorage.app",
            messagingSenderId: "925117697794",
            appId: "1:925117697794:web:4a8a4ce97e343fead07c1b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let myNick = localStorage.getItem('chat_nick');
        let isAdmin = localStorage.getItem('is_admin') === 'true';
        let currentVideoData = null;

        // === –°–ù–ï–ñ–ò–ù–ö–ò ===
        for (let i = 0; i < 50; i++) {
            const snow = document.createElement('div');
            snow.className = 'snowflake';
            snow.textContent = '‚ùÑ';
            snow.style.left = Math.random() * 100 + '%';
            snow.style.fontSize = (Math.random() * 10 + 10) + 'px';
            snow.style.animationDuration = (Math.random() * 10 + 5) + 's';
            snow.style.animationDelay = Math.random() * 5 + 's';
            document.body.appendChild(snow);
        }

        // === –¢–ê–ô–ú–ï–† ===
        function updateTimer() {
            const now = new Date();
            const newYear = new Date(now.getFullYear() + 1, 0, 1, 0, 0, 0);
            const diff = newYear - now;

            if (diff <= 0) {
                document.getElementById('timerTitle').innerHTML = 'üéä –° –ù–û–í–´–ú –ì–û–î–û–ú! üéä';
                document.getElementById('timer').innerHTML = '<div style="font-size:48px; animation:pulse 1s infinite">üéâüéÜüéä</div>';
                return;
            }

            const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const minutes = Math.floor((diff / 1000 / 60) % 60);
            const seconds = Math.floor((diff / 1000) % 60);

            document.getElementById('hours').textContent = String(hours).padStart(2, '0');
            document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
            document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
        }
        updateTimer();
        setInterval(updateTimer, 1000);

        // === –í–•–û–î ===
        window.join = () => {
            const nick = document.getElementById('nickInput').value.trim();
            if (!nick) return;
            myNick = nick;
            localStorage.setItem('chat_nick', nick);
            
            const userRef = ref(db, 'online/' + nick);
            set(userRef, { time: Date.now() });
            onDisconnect(userRef).remove();

            document.getElementById('loginModal').classList.add('hidden');
        };

        // === –û–ù–õ–ê–ô–ù –°–ü–ò–°–û–ö ===
        onValue(ref(db, 'online'), (snap) => {
            const list = document.getElementById('onlineList');
            if (list) {
                list.innerHTML = '';
                snap.forEach(u => {
                    list.innerHTML += `<span class="user-tag">${u.key}</span>`;
                });
            }
        });

        // === –í–ò–î–ï–û –ü–õ–ï–ï–† ===
        onValue(ref(db, 'video/current'), (snap) => {
            currentVideoData = snap.val();
            const cinema = document.getElementById('cinema');
            const frame = document.getElementById('videoFrame');
            const overlay = document.getElementById('videoOverlay');

            if (!currentVideoData || !currentVideoData.url) {
                cinema.classList.remove('active');
                return;
            }

            cinema.classList.add('active');
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –∏–∑ YouTube —Å—Å—ã–ª–∫–∏
            let videoId = '';
            const match = currentVideoData.url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([^&?#]+)/);
            if (match) {
                videoId = match[1];
                const timestamp = currentVideoData.time || 0;
                const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&start=${Math.floor(timestamp)}&enablejsapi=1`;
                frame.src = embedUrl;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –µ—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω
            if (!isAdmin) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        });

        window.syncVideo = () => {
            document.getElementById('videoOverlay').classList.add('hidden');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ—Ä–µ–π–º –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            const frame = document.getElementById('videoFrame');
            const currentSrc = frame.src;
            frame.src = '';
            setTimeout(() => frame.src = currentSrc, 100);
        };

        // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –ê–î–ú–ò–ù–ê ===
        window.startVideo = () => {
            const url = document.getElementById('videoUrl').value.trim();
            if (!url) return;
            
            set(ref(db, 'video/current'), {
                url: url,
                time: 0,
                startedAt: Date.now()
            });
            
            document.getElementById('adminModal').classList.add('hidden');
        };

        window.stopVideo = () => {
            remove(ref(db, 'video/current'));
            document.getElementById('adminModal').classList.add('hidden');
        };

        window.openAdmin = () => {
            const pass = prompt("üîê –í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å:");
            if (pass === "2025") {
                isAdmin = true;
                localStorage.setItem('is_admin', 'true');
                document.getElementById('adminModal').classList.remove('hidden');
            } else if (pass) {
                alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
            }
        };

        window.closeAdmin = () => {
            document.getElementById('adminModal').classList.add('hidden');
        };

        // === –ß–ê–¢ ===
        window.sendMsg = () => {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (text && myNick) {
                push(ref(db, 'messages'), {
                    user: myNick,
                    text: text,
                    time: Date.now()
                });
                input.value = '';
            }
        };

        onChildAdded(ref(db, 'messages'), (snap) => {
            const msg = snap.val();
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `msg ${msg.user === myNick ? 'own' : 'other'}`;
            div.innerHTML = `
                <div class="msg-user">${msg.user}</div>
                <div>${msg.text}</div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        });

        // === ENTER –î–õ–Ø –û–¢–ü–†–ê–í–ö–ò ===
        document.getElementById('msgInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMsg();
        });

        document.getElementById('nickInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') join();
        });

        // === –ê–í–¢–û–í–•–û–î ===
        if (myNick) {
            document.getElementById('loginModal').classList.add('hidden');
            const userRef = ref(db, 'online/' + myNick);
            set(userRef, { time: Date.now() });
            onDisconnect(userRef).remove();
        }
    </script>
</body>
</html>

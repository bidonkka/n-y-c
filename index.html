<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ß–∞—Ç üéÑ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            min-height: 100vh; overflow-x: hidden; position: relative; user-select: none;
        }

        /* --- –°–Ω–µ–≥ –∏ –°–∞–ª—é—Ç --- */
        .snowflake { position: fixed; top: -10px; color: white; pointer-events: none; z-index: 1; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(100vh); } }
        .firework { position: fixed; font-size: 40px; pointer-events: none; z-index: 9999; animation: firework 1s ease-out forwards; }
        @keyframes firework { 0% { transform: scale(0); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.8; } 100% { transform: scale(0.5); opacity: 0; } }

        .container { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; z-index: 10; }

        /* --- –¢–∞–π–º–µ—Ä --- */
        .timer-box {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px);
            border-radius: 30px; padding: 20px; margin-bottom: 20px; border: 2px solid rgba(255, 255, 255, 0.2);
            text-align: center; color: white;
        }
        .timer { display: flex; justify-content: center; gap: 15px; margin-top: 10px; }
        .time-unit { background: rgba(255, 255, 255, 0.2); padding: 10px; border-radius: 15px; min-width: 70px; }
        .time-value { font-size: 32px; font-weight: bold; color: #fcd34d; }

        /* --- –ß–∞—Ç --- */
        .chat-container {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px);
            border-radius: 30px; border: 2px solid rgba(255, 255, 255, 0.2); overflow: hidden;
        }
        .chat-header {
            background: rgba(255, 255, 255, 0.1); padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .messages { height: 450px; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        .message { display: flex; flex-direction: column; max-width: 75%; position: relative; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } }
        
        .message.own { align-self: flex-end; }
        .message.other { align-self: flex-start; }
        
        .message-content {
            padding: 10px 15px; border-radius: 18px; cursor: pointer; position: relative;
        }
        .message.own .message-content { background: #f59e0b; color: white; border-bottom-right-radius: 4px; }
        .message.other .message-content { background: rgba(255, 255, 255, 0.2); color: white; border-bottom-left-radius: 4px; }
        
        .message-user { font-size: 11px; opacity: 0.8; margin-bottom: 2px; padding: 0 5px; }
        .message.own .message-user { text-align: right; }

        .like-badge {
            position: absolute; bottom: -8px; right: -5px; background: white; color: #ef4444;
            padding: 1px 6px; border-radius: 10px; font-size: 11px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .input-area { padding: 15px; display: flex; gap: 10px; background: rgba(0, 0, 0, 0.2); }
        input { flex: 1; padding: 12px; border-radius: 12px; border: none; background: rgba(255, 255, 255, 0.2); color: white; outline: none; }
        .send-btn { background: #f59e0b; border: none; padding: 10px 20px; border-radius: 12px; color: white; cursor: pointer; }

        /* --- –ú–æ–¥–∞–ª–∫–∏ --- */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center; z-index: 2000;
        }
        .modal-content {
            background: #1e293b; color: white; padding: 30px; border-radius: 25px;
            width: 90%; max-width: 450px; text-align: center; border: 1px solid rgba(255,255,255,0.1);
        }
        .hidden { display: none !important; }

        /* –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å –°–ø–∏—Å–æ–∫ */
        .user-list { max-height: 200px; overflow-y: auto; margin: 15px 0; text-align: left; }
        .user-item {
            background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 10px;
            margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;
        }
        .action-btns button { padding: 4px 8px; font-size: 11px; margin-left: 5px; cursor: pointer; border: none; border-radius: 5px; color: white; }
        .btn-kick { background: #f97316; }
        .btn-ban { background: #ef4444; }

        .icon-btn { background: none; border: none; font-size: 20px; cursor: pointer; opacity: 0.7; transition: 0.2s; }
        .icon-btn:hover { opacity: 1; transform: scale(1.1); }
    </style>
</head>
<body>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2>üéÑ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
            <p style="margin: 10px 0; opacity: 0.7;">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º</p>
            <input type="text" id="nickInput" placeholder="–í–∞—à –Ω–∏–∫..." maxlength="15" style="width: 100%; margin: 10px 0;">
            <button onclick="joinChat()" class="send-btn" style="width: 100%;">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <div id="adminModal" class="modal hidden">
        <div class="modal-content">
            <h3>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <div class="user-list" id="userList">
                </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="adminAction('santa')" class="send-btn" style="background: #10b981;">üéÖ –û—Ç –ª–∏—Ü–∞ –ú–æ—Ä–æ–∑–∞</button>
                <button onclick="adminAction('fireworks')" class="send-btn" style="background: #8b5cf6;">üéÜ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∞–ª—é—Ç</button>
                <button onclick="adminAction('clear')" class="send-btn" style="background: #ef4444; grid-column: span 2;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —á–∞—Ç</button>
            </div>
            <button onclick="closeAdmin()" class="send-btn" style="background: grey; margin-top: 15px; width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div class="container">
        <div class="timer-box">
            <h3 id="timerTitle">‚è∞ –î–æ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞:</h3>
            <div class="timer">
                <div class="time-unit"><div class="time-value" id="h">00</div></div>
                <div class="time-unit"><div class="time-value" id="m">00</div></div>
                <div class="time-unit"><div class="time-value" id="s">00</div></div>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <div>
                    <h4 id="userNameDisplay">–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ß–∞—Ç</h4>
                    <span style="font-size: 11px; opacity: 0.6;">–û–Ω–ª–∞–π–Ω-–æ–±—â–µ–Ω–∏–µ</span>
                </div>
                <div>
                    <button class="icon-btn" onclick="logout()">üö™</button>
                    <button class="icon-btn" onclick="openAdmin()">‚öôÔ∏è</button>
                </div>
            </div>
            <div class="messages" id="chatBox"></div>
            <div class="input-area">
                <input type="text" id="msgInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="send-btn" onclick="sendMsg()">üì®</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onChildAdded, onChildChanged, remove, onValue, set, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDOhC3fadF5gs73HgD3kkeRFE1YGgixgAA",
            authDomain: "new-year-chat.firebaseapp.com",
            databaseURL: "https://new-year-chat-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "new-year-chat",
            storageBucket: "new-year-chat.firebasestorage.app",
            messagingSenderId: "925117697794",
            appId: "1:925117697794:web:4a8a4ce97e343fead07c1b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let myNick = localStorage.getItem('chat_nick');
        const ADMIN_PASS = "2025";

        // --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
        if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission();
        }

        function showNotification(user, text) {
            if (document.hidden && Notification.permission === "granted") {
                new Notification("üéÑ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ", { body: `${user}: ${text}`, icon: "https://cdn-icons-png.flaticon.com/512/3893/3893071.png" });
            }
        }

        // --- –ë–ê–ù –ò –ö–ò–ö –°–ò–°–¢–ï–ú–ê ---
        function checkUserStatus() {
            if (!myNick) return;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–∞–Ω
            onValue(ref(db, 'banned/' + myNick), (snap) => {
                if (snap.exists()) {
                    const banUntil = snap.val();
                    if (Date.now() < banUntil) {
                        alert(`‚ùå –í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –¥–æ ${new Date(banUntil).toLocaleTimeString()}`);
                        logout();
                    }
                }
            });

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∏–∫
            onValue(ref(db, 'users/' + myNick + '/kicked'), (snap) => {
                if (snap.val() === true) {
                    set(ref(db, 'users/' + myNick + '/kicked'), false);
                    alert("‚ö†Ô∏è –í—ã –±—ã–ª–∏ –∫–∏–∫–Ω—É—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!");
                    logout();
                }
            });
        }

        // --- –§–£–ù–ö–¶–ò–ò –í–•–û–î–ê ---
        window.joinChat = () => {
            const nick = document.getElementById('nickInput').value.trim();
            if (!nick) return;

            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º, –Ω–µ –≤ –±–∞–Ω–µ –ª–∏ –Ω–∏–∫
            onValue(ref(db, 'banned/' + nick), (snap) => {
                if (snap.exists() && Date.now() < snap.val()) {
                    alert("‚ùå –≠—Ç–æ—Ç –Ω–∏–∫ –∑–∞–±–∞–Ω–µ–Ω!");
                } else {
                    myNick = nick;
                    localStorage.setItem('chat_nick', nick);
                    set(ref(db, 'users/' + nick), { lastSeen: serverTimestamp(), kicked: false });
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('userNameDisplay').innerText = "–ü—Ä–∏–≤–µ—Ç, " + myNick;
                    checkUserStatus();
                }
            }, { onlyOnce: true });
        };

        window.logout = () => {
            localStorage.removeItem('chat_nick');
            location.reload();
        };

        // --- –ß–ê–¢ –õ–û–ì–ò–ö–ê ---
        window.sendMsg = () => {
            const inp = document.getElementById('msgInput');
            if (inp.value.trim() && myNick) {
                push(ref(db, 'messages'), {
                    user: myNick,
                    text: inp.value.trim(),
                    time: serverTimestamp(),
                    likes: 0
                });
                inp.value = "";
            }
        };

        onChildAdded(ref(db, 'messages'), (snap) => {
            const m = snap.val();
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `message ${m.user === myNick ? 'own' : 'other'}`;
            div.id = "m-" + snap.key;
            
            const likesCount = m.likes || 0;
            const likeHtml = likesCount > 0 ? `<div class="like-badge">‚ù§Ô∏è ${likesCount}</div>` : "";

            div.innerHTML = `
                <div class="message-user">${m.user}</div>
                <div class="message-content" ondblclick="addLike('${snap.key}')">
                    ${m.text}
                    ${likeHtml}
                </div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            if (m.user !== myNick) showNotification(m.user, m.text);
        });

        window.addLike = (key) => {
            const likeRef = ref(db, `messages/${key}/likes`);
            onValue(likeRef, (snap) => {
                set(likeRef, (snap.val() || 0) + 1);
            }, { onlyOnce: true });
        };

        onChildChanged(ref(db, 'messages'), (snap) => {
            const el = document.getElementById("m-" + snap.key);
            if (el) {
                const likes = snap.val().likes || 0;
                let badge = el.querySelector('.like-badge');
                if (likes > 0) {
                    if (!badge) {
                        el.querySelector('.message-content').insertAdjacentHTML('beforeend', `<div class="like-badge">‚ù§Ô∏è ${likes}</div>`);
                    } else {
                        badge.innerText = "‚ù§Ô∏è " + likes;
                    }
                }
            }
        });

        // --- –ê–î–ú–ò–ù–ö–ê ---
        window.openAdmin = () => {
            if (prompt("–ü–∞—Ä–æ–ª—å:") === ADMIN_PASS) {
                document.getElementById('adminModal').classList.remove('hidden');
                loadUsers();
            }
        };

        window.closeAdmin = () => document.getElementById('adminModal').classList.add('hidden');

        function loadUsers() {
            onValue(ref(db, 'users'), (snap) => {
                const list = document.getElementById('userList');
                list.innerHTML = "";
                snap.forEach(child => {
                    const name = child.key;
                    list.innerHTML += `
                        <div class="user-item">
                            <span>${name}</span>
                            <div class="action-btns">
                                <button class="btn-kick" onclick="kickUser('${name}')">Kick</button>
                                <button class="btn-ban" onclick="banUser('${name}')">Ban 10m</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        window.kickUser = (name) => set(ref(db, `users/${name}/kicked`), true);
        window.banUser = (name) => {
            const until = Date.now() + (10 * 60 * 1000); // 10 –º–∏–Ω—É—Ç
            set(ref(db, 'banned/' + name), until);
            kickUser(name);
        };

        window.adminAction = (act) => {
            if (act === 'clear') remove(ref(db, 'messages'));
            if (act === 'fireworks') set(ref(db, 'signal/fire'), Date.now());
            if (act === 'santa') {
                const t = prompt("–ß—Ç–æ —Å–∫–∞–∂–µ—Ç –î–µ–¥ –ú–æ—Ä–æ–∑?");
                if (t) push(ref(db, 'messages'), { user: "üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑", text: t, time: serverTimestamp() });
            }
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–∞–ª—é—Ç
        onValue(ref(db, 'signal/fire'), () => launchFireworks());

        // --- –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï ---
        function createSnow() {
            for(let i=0; i<30; i++) {
                const s = document.createElement('div');
                s.className = 'snowflake'; s.innerText = '‚ùÑ';
                s.style.left = Math.random()*100+'%'; s.style.animationDuration = (Math.random()*5+5)+'s';
                document.body.appendChild(s);
            }
        }
        function launchFireworks() {
            for(let i=0; i<15; i++) {
                setTimeout(() => {
                    const f = document.createElement('div'); f.className = 'firework'; f.innerText = '‚ú®';
                    f.style.left = Math.random()*100+'%'; f.style.top = Math.random()*100+'%';
                    document.body.appendChild(f); setTimeout(()=>f.remove(), 1000);
                }, i*100);
            }
        }
        function updateTimer() {
            const diff = new Date(new Date().getFullYear() + 1, 0, 1) - new Date();
            if (diff <= 0) { document.getElementById('timerTitle').innerText = "üéÑ –° –ù–û–í–´–ú –ì–û–î–û–ú! üéÑ"; return; }
            document.getElementById('h').innerText = Math.floor(diff/3600000%24);
            document.getElementById('m').innerText = Math.floor(diff/60000%60);
            document.getElementById('s').innerText = Math.floor(diff/1000%60);
        }

        createSnow();
        setInterval(updateTimer, 1000);
        if (myNick) {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('userNameDisplay').innerText = "–ü—Ä–∏–≤–µ—Ç, " + myNick;
            checkUserStatus();
        }
    </script>
</body>
</html>

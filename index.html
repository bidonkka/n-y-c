<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ß–∞—Ç üéÑ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%);
            min-height: 100vh; overflow-x: hidden; position: relative;
        }

        /* --- –ê–Ω–∏–º–∞—Ü–∏–∏ —Ñ–æ–Ω–∞ --- */
        .snowflake { position: fixed; top: -10px; color: white; pointer-events: none; z-index: 1; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(100vh); } }
        .firework { position: fixed; font-size: 40px; pointer-events: none; z-index: 9999; animation: firework 1s ease-out forwards; }
        @keyframes firework { 0% { transform: scale(0); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.8; } 100% { transform: scale(0.5); opacity: 0; } }

        .container { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; z-index: 10; }

        /* --- –í–æ–∑–≤—Ä–∞—â–µ–Ω–Ω—ã–π –î–∏–∑–∞–π–Ω –¢–∞–π–º–µ—Ä–∞ --- */
        .timer-box {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px);
            border-radius: 30px; padding: 30px; margin-bottom: 20px; border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); text-align: center;
        }
        .timer-title { color: white; font-size: 28px; font-weight: bold; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
        .timer { display: flex; justify-content: center; gap: 20px; }
        .time-unit { background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(250, 204, 21, 0.5); border-radius: 20px; padding: 20px; min-width: 90px; }
        .time-value { font-size: 48px; font-weight: bold; color: #fcd34d; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
        .time-label { color: rgba(255, 255, 255, 0.8); font-size: 14px; margin-top: 5px; }

        /* --- –í–æ–∑–≤—Ä–∞—â–µ–Ω–Ω—ã–π –î–∏–∑–∞–π–Ω –ß–∞—Ç–∞ --- */
        .chat-container {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px);
            border-radius: 30px; border: 2px solid rgba(255, 255, 255, 0.2); overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .chat-header {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(249, 115, 22, 0.3));
            padding: 20px; border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            display: flex; justify-content: space-between; align-items: center;
        }
        .messages { height: 400px; overflow-y: auto; padding: 20px; background: rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        
        .message { margin-bottom: 15px; display: flex; flex-direction: column; max-width: 70%; animation: slideIn 0.3s ease-out; position: relative; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } }
        
        .message.own { align-self: flex-end; }
        .message.other { align-self: flex-start; }
        
        .message-content {
            padding: 12px 16px; border-radius: 20px; cursor: pointer; position: relative; transition: transform 0.1s;
        }
        .message.own .message-content { background: linear-gradient(135deg, #fbbf24, #f97316); color: white; }
        .message.other .message-content { background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.3); color: white; }
        
        .message-user { font-size: 12px; opacity: 0.7; margin-bottom: 4px; }
        .message.own .message-user { text-align: right; }

        .like-badge {
            position: absolute; bottom: -10px; right: -5px; background: white; color: #ef4444;
            padding: 2px 6px; border-radius: 10px; font-size: 12px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .input-area { padding: 20px; background: rgba(255, 255, 255, 0.05); display: flex; gap: 10px; }
        input { flex: 1; padding: 15px; border-radius: 15px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.2); color: white; outline: none; }
        button { padding: 10px 25px; border-radius: 15px; border: none; background: #f59e0b; color: white; font-weight: bold; cursor: pointer; }

        /* --- –ú–æ–¥–∞–ª–∫–∏ --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: rgba(30, 41, 59, 0.9); padding: 30px; border-radius: 30px; width: 90%; max-width: 450px; text-align: center; color: white; border: 2px solid rgba(255,255,255,0.1); }
        .hidden { display: none !important; }

        .user-list { max-height: 250px; overflow-y: auto; margin: 20px 0; background: rgba(0,0,0,0.2); border-radius: 15px; padding: 10px; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .admin-btns button { padding: 5px 10px; margin-left: 5px; border-radius: 8px; border: none; color: white; font-size: 12px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h1>üéÑ –° –ù–æ–≤—ã–º –ì–æ–¥–æ–º!</h1>
            <p style="margin: 15px 0;">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏ –≤ —á–∞—Ç</p>
            <input type="text" id="nickInput" placeholder="–í–∞—à –Ω–∏–∫..." maxlength="15" style="width: 100%;">
            <button onclick="joinChat()" style="width: 100%; margin-top: 10px;">–í–æ–π—Ç–∏ üéâ</button>
        </div>
    </div>

    <div id="adminModal" class="modal hidden">
        <div class="modal-content">
            <h2>‚öôÔ∏è –ê–¥–º–∏–Ω-–ü–∞–Ω–µ–ª—å</h2>
            <div class="user-list" id="userList"></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button onclick="adminAction('santa')" style="background: #10b981;">üéÖ –û—Ç –ú–æ—Ä–æ–∑–∞</button>
                <button onclick="adminAction('fireworks')" style="background: #8b5cf6;">üéÜ –í—Å–µ–º —Å–∞–ª—é—Ç</button>
                <button onclick="adminAction('clear')" style="background: #ef4444; grid-column: span 2;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —á–∞—Ç</button>
            </div>
            <button onclick="closeAdmin()" style="background: rgba(255,255,255,0.1); margin-top: 15px; width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div class="container">
        <div class="timer-box">
            <div class="timer-title" id="timerTitle">‚è∞ –î–æ –ù–æ–≤–æ–≥–æ –ì–æ–¥–∞:</div>
            <div class="timer">
                <div class="time-unit"><div class="time-value" id="h">00</div><div class="time-label">—á–∞—Å–æ–≤</div></div>
                <div class="time-unit"><div class="time-value" id="m">00</div><div class="time-label">–º–∏–Ω—É—Ç</div></div>
                <div class="time-unit"><div class="time-value" id="s">00</div><div class="time-label">—Å–µ–∫—É–Ω–¥</div></div>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <div>
                    <h3 id="userNameDisplay">–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ß–∞—Ç</h3>
                    <p style="font-size: 12px; color: rgba(255,255,255,0.7);" id="statusSub">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
                <div>
                    <button style="background:none; font-size:20px; cursor:pointer;" onclick="logout()">üö™</button>
                    <button style="background:none; font-size:20px; cursor:pointer;" onclick="openAdmin()">‚öôÔ∏è</button>
                </div>
            </div>
            <div class="messages" id="chatBox"></div>
            <div class="input-area">
                <input type="text" id="msgInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button onclick="sendMsg()">üì®</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onChildAdded, onChildChanged, remove, onValue, set, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDOhC3fadF5gs73HgD3kkeRFE1YGgixgAA",
            authDomain: "new-year-chat.firebaseapp.com",
            databaseURL: "https://new-year-chat-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "new-year-chat",
            storageBucket: "new-year-chat.firebasestorage.app",
            messagingSenderId: "925117697794",
            appId: "1:925117697794:web:4a8a4ce97e343fead07c1b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let myNick = localStorage.getItem('chat_nick');
        const ADMIN_PASS = "2025";

        // --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
        if ("Notification" in window && Notification.permission === "default") Notification.requestPermission();
        function showNotification(user, text) {
            if (document.hidden && Notification.permission === "granted") {
                new Notification("üéÑ –°–æ–æ–±—â–µ–Ω–∏–µ", { body: `${user}: ${text}` });
            }
        }

        // --- –ë–ê–ù / –ö–ò–ö –õ–û–ì–ò–ö–ê ---
        function checkStatus() {
            if (!myNick) return;
            onValue(ref(db, 'banned/' + myNick), (snap) => {
                if (snap.exists() && Date.now() < snap.val()) {
                    alert("‚ùå –í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –¥–æ " + new Date(snap.val()).toLocaleTimeString());
                    logout();
                }
            });
            onValue(ref(db, 'users/' + myNick + '/kicked'), (snap) => {
                if (snap.val() === true) {
                    set(ref(db, 'users/' + myNick + '/kicked'), false);
                    alert("‚ö†Ô∏è –í–∞—Å –∫–∏–∫–Ω—É–ª–∏!");
                    logout();
                }
            });
        }

        // --- –í–•–û–î ---
        window.joinChat = () => {
            const nick = document.getElementById('nickInput').value.trim();
            if (!nick) return;
            myNick = nick;
            localStorage.setItem('chat_nick', nick);
            set(ref(db, 'users/' + nick), { lastSeen: serverTimestamp(), kicked: false });
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('statusSub').innerText = "–ü—Ä–∏–≤–µ—Ç, " + myNick;
            checkStatus();
        };

        window.logout = () => {
            localStorage.removeItem('chat_nick');
            location.reload();
        };

        // --- –ß–ê–¢ (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω Enter) ---
        window.sendMsg = () => {
            const inp = document.getElementById('msgInput');
            if (inp.value.trim() && myNick) {
                push(ref(db, 'messages'), { user: myNick, text: inp.value.trim(), time: serverTimestamp(), likes: 0 });
                inp.value = "";
            }
        };

        // –°–ª—É—à–∞–µ–º Enter –≤ —á–∞—Ç–µ
        document.getElementById('msgInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMsg();
        });

        onChildAdded(ref(db, 'messages'), (snap) => {
            const m = snap.val();
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = `message ${m.user === myNick ? 'own' : 'other'}`;
            div.id = "m-" + snap.key;
            
            const likes = m.likes || 0;
            const likeBadge = likes > 0 ? `<div class="like-badge">‚ù§Ô∏è ${likes}</div>` : "";

            div.innerHTML = `
                <div class="message-user">${m.user}</div>
                <div class="message-content" ondblclick="addLike('${snap.key}')">
                    ${m.text}
                    ${likeBadge}
                </div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            if (m.user !== myNick) showNotification(m.user, m.text);
        });

        window.addLike = (key) => {
            const r = ref(db, `messages/${key}/likes`);
            onValue(r, (s) => set(r, (s.val() || 0) + 1), { onlyOnce: true });
        };

        onChildChanged(ref(db, 'messages'), (snap) => {
            const el = document.getElementById("m-" + snap.key);
            if (el) {
                const likes = snap.val().likes || 0;
                let badge = el.querySelector('.like-badge');
                if (likes > 0) {
                    if (!badge) el.querySelector('.message-content').insertAdjacentHTML('beforeend', `<div class="like-badge">‚ù§Ô∏è ${likes}</div>`);
                    else badge.innerText = "‚ù§Ô∏è " + likes;
                }
            }
        });

        // --- –ê–î–ú–ò–ù–ö–ê (–ó–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ) ---
        window.openAdmin = () => {
            let savedPass = localStorage.getItem('admin_access');
            if (savedPass === ADMIN_PASS || prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞:") === ADMIN_PASS) {
                localStorage.setItem('admin_access', ADMIN_PASS);
                document.getElementById('adminModal').classList.remove('hidden');
                loadUserList();
            } else {
                alert("–ù–µ–≤–µ—Ä–Ω–æ!");
            }
        };

        window.closeAdmin = () => document.getElementById('adminModal').classList.add('hidden');

        function loadUserList() {
            onValue(ref(db, 'users'), (snap) => {
                const list = document.getElementById('userList');
                list.innerHTML = "";
                snap.forEach(c => {
                    const name = c.key;
                    list.innerHTML += `
                        <div class="user-item">
                            <span>${name}</span>
                            <div class="admin-btns">
                                <button style="background:#f97316" onclick="kick('${name}')">Kick</button>
                                <button style="background:#ef4444" onclick="banPrompt('${name}')">Ban</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        window.kick = (name) => set(ref(db, `users/${name}/kicked`), true);
        
        window.banPrompt = (name) => {
            const mins = prompt("–ù–∞ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è " + name + "?", "10");
            if (mins) {
                const until = Date.now() + (parseInt(mins) * 60 * 1000);
                set(ref(db, 'banned/' + name), until);
                kick(name);
                alert(name + " –∑–∞–±–∞–Ω–µ–Ω –Ω–∞ " + mins + " –º–∏–Ω.");
            }
        };

        window.adminAction = (a) => {
            if (a === 'clear') remove(ref(db, 'messages'));
            if (a === 'fireworks') set(ref(db, 'signal/fire'), Date.now());
            if (a === 'santa') {
                const t = prompt("–ß—Ç–æ —Å–∫–∞–∂–µ—Ç –°–∞–Ω—Ç–∞?");
                if (t) push(ref(db, 'messages'), { user: "üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑", text: t, time: serverTimestamp() });
            }
        };

        onValue(ref(db, 'signal/fire'), () => launchFireworks());

        // --- –≠–§–§–ï–ö–¢–´ ---
        function createSnow() {
            for(let i=0; i<30; i++){
                const s = document.createElement('div'); s.className='snowflake'; s.innerText='‚ùÑ';
                s.style.left=Math.random()*100+'%'; s.style.animationDuration=(Math.random()*5+5)+'s';
                document.body.appendChild(s);
            }
        }
        function launchFireworks() {
            for(let i=0; i<15; i++){
                setTimeout(() => {
                    const f = document.createElement('div'); f.className='firework'; f.innerText='‚ú®';
                    f.style.left=Math.random()*100+'%'; f.style.top=Math.random()*100+'%';
                    document.body.appendChild(f); setTimeout(()=>f.remove(), 1000);
                }, i*100);
            }
        }
        function timer() {
            const diff = new Date(2026, 0, 1) - new Date();
            if(diff <= 0) { document.getElementById('timerTitle').innerText="üéä –° –ù–û–í–´–ú –ì–û–î–û–ú! üéä"; return; }
            document.getElementById('h').innerText = Math.floor(diff/3600000%24).toString().padStart(2,'0');
            document.getElementById('m').innerText = Math.floor(diff/60000%60).toString().padStart(2,'0');
            document.getElementById('s').innerText = Math.floor(diff/1000%60).toString().padStart(2,'0');
        }

        createSnow();
        setInterval(timer, 1000);
        if (myNick) {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('statusSub').innerText = "–ü—Ä–∏–≤–µ—Ç, " + myNick;
            checkStatus();
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä üéÑ</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; overflow-x: hidden; }
        
        .container { max-width: 900px; margin: 0 auto; padding: 15px; }

        /* --- –ü–õ–ï–ï–† --- */
        .cinema-wrapper {
            background: #000; border-radius: 20px; border: 2px solid #fcd34d;
            position: relative; overflow: hidden; margin-bottom: 15px;
            aspect-ratio: 16/9; display: none; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #yt-player, #html5-player { width: 100%; height: 100%; position: absolute; inset: 0; }
        .hidden { display: none !important; }

        /* –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∑–≤—É–∫–∞/–≤–∏–¥–µ–æ –¥–ª—è —é–∑–µ—Ä–æ–≤ */
        #sync-overlay {
            position: absolute; inset: 0; z-index: 100; background: rgba(0,0,0,0.8);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø–ª–µ–µ—Ä–∞ */
        .admin-controls {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 110;
            background: rgba(0,0,0,0.8); padding: 10px; display: flex; align-items: center; gap: 10px;
        }
        .progress-bar { flex: 1; accent-color: #fcd34d; cursor: pointer; }

        /* –ß–∞—Ç */
        .chat-area { background: rgba(255,255,255,0.05); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); height: 400px; display: flex; flex-direction: column; }
        #chatBox { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 14px; line-height: 1.4; }
        .msg.own { align-self: flex-end; background: #f59e0b; color: black; }
        .msg.other { align-self: flex-start; background: #334155; }

        .input-box { padding: 15px; display: flex; gap: 8px; }
        input { background: #1e293b; border: 1px solid #475569; color: white; padding: 10px; border-radius: 10px; flex: 1; outline: none; }
        
        /* –ú–æ–¥–∞–ª–∫–∏ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-inner { background: #1e293b; padding: 25px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; }
        .btn { background: #fcd34d; color: black; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        
        .user-tag { background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 2px 8px; border-radius: 5px; font-size: 12px; margin: 5px; display: inline-block; }
    </style>
</head>
<body>

    <div id="loginModal" class="modal">
        <div class="modal-inner">
            <h2 style="margin-bottom:15px">üéâ –° –ù–æ–≤—ã–º –ì–æ–¥–æ–º!</h2>
            <input type="text" id="nickInput" placeholder="–í–∞—à –Ω–∏–∫..." maxlength="15">
            <button class="btn" onclick="join()" style="width:100%; margin-top:10px">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div id="adminModal" class="modal hidden">
        <div class="modal-inner">
            <h3>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <input type="text" id="mediaUrl" placeholder="YouTube –∏–ª–∏ –ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ .mp4" style="width:100%; margin:10px 0">
            <button class="btn" onclick="startMedia()" style="background:#10b981; color:white">–°–¢–ê–†–¢</button>
            <button class="btn" onclick="stopMedia()" style="background:#ef4444; color:white">–°–¢–û–ü</button>
            <div id="onlineList" style="margin-top:15px; text-align:left; border-top:1px solid #444; padding-top:10px;"></div>
            <button class="btn" onclick="closeAdmin()" style="margin-top:15px; background:#475569; color:white">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <div class="container">
        <div id="cinema" class="cinema-wrapper">
            <div id="yt-player"></div>
            <video id="html5-player" class="hidden" playsinline></video>
            
            <div id="sync-overlay" class="hidden">
                <p style="margin-bottom:10px">–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É</p>
                <button class="btn" onclick="forceSync()">–°–ú–û–¢–†–ï–¢–¨ –í–ú–ï–°–¢–ï üçø</button>
            </div>

            <div id="adminControls" class="admin-controls hidden">
                <button onclick="togglePlay()" id="playBtn" style="background:none; border:none; color:#fcd34d; font-size:20px; cursor:pointer">‚ñ∂</button>
                <input type="range" id="progressBar" class="progress-bar" min="0" value="0">
                <span id="timeShow" style="font-size:12px">00:00</span>
            </div>
        </div>

        <div class="chat-area">
            <div style="padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between">
                <span>üéÑ –ß–∞—Ç</span>
                <button onclick="openAdmin()" style="background:none; border:none; color:#fcd34d; cursor:pointer">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>
            <div id="chatBox"></div>
            <div class="input-box">
                <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button onclick="send()" class="btn">üì®</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onChildAdded, remove, onValue, set, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDOhC3fadF5gs73HgD3kkeRFE1YGgixgAA",
            authDomain: "new-year-chat.firebaseapp.com",
            databaseURL: "https://new-year-chat-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "new-year-chat",
            storageBucket: "new-year-chat.firebasestorage.app",
            messagingSenderId: "925117697794",
            appId: "1:925117697794:web:4a8a4ce97e343fead07c1b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let myNick = localStorage.getItem('chat_nick');
        let isAdmin = localStorage.getItem('is_admin') === 'true';
        let ytPlayer = null;
        let htmlPlayer = document.getElementById('html5-player');
        let currentData = null;

        // --- PRESENCE (–°–ü–ò–°–û–ö –û–ù–õ–ê–ô–ù) ---
        window.join = () => {
            const nick = document.getElementById('nickInput').value.trim();
            if (!nick) return;
            myNick = nick;
            localStorage.setItem('chat_nick', nick);
            
            const userRef = ref(db, 'online/' + nick);
            set(userRef, { lastSeen: Date.now() });
            onDisconnect(userRef).remove(); // –£–¥–∞–ª—è–µ–º –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ

            document.getElementById('loginModal').classList.add('hidden');
        };

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞
        onValue(ref(db, 'online'), (snap) => {
            const list = document.getElementById('onlineList');
            if (list) {
                list.innerHTML = '<b>–í —Å–µ—Ç–∏:</b><br>';
                snap.forEach(u => {
                    list.innerHTML += `<span class="user-tag">${u.key}</span>`;
                });
            }
        });

        // --- YOUTUBE API ---
        window.onYouTubeIframeAPIReady = () => {
            ytPlayer = new YT.Player('yt-player', {
                height: '100%', width: '100%',
                playerVars: { 'controls': 0, 'disablekb': 1, 'rel': 0 },
                events: { 'onStateChange': (e) => { if(isAdmin) handleYTState(e); } }
            });
        };

        // --- –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ü–õ–ï–ï–†–ê ---
        onValue(ref(db, 'cinema/state'), (snap) => {
            currentData = snap.val();
            const cinema = document.getElementById('cinema');
            const syncOverlay = document.getElementById('sync-overlay');
            
            if (!currentData) {
                cinema.style.display = 'none';
                if(ytPlayer?.stopVideo) ytPlayer.stopVideo();
                htmlPlayer.pause();
                return;
            }

            cinema.style.display = 'block';
            
            // –ï—Å–ª–∏ –º—ã –Ω–µ –∞–¥–º–∏–Ω –∏ –≤–∏–¥–µ–æ –Ω–µ –∏–≥—Ä–∞–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å"
            if (!isAdmin) {
                syncOverlay.classList.remove('hidden');
            } else {
                document.getElementById('adminControls').classList.remove('hidden');
            }

            if (currentData.type === 'youtube') {
                htmlPlayer.classList.add('hidden');
                document.getElementById('yt-player').classList.remove('hidden');
                let vidId = currentData.src;
                if(ytPlayer?.getVideoData?.()?.video_id !== vidId) {
                    ytPlayer.cueVideoById(vidId);
                }
            } else {
                document.getElementById('yt-player').classList.add('hidden');
                htmlPlayer.classList.remove('hidden');
                if(htmlPlayer.src !== currentData.src) htmlPlayer.src = currentData.src;
            }
        });

        window.forceSync = () => {
            document.getElementById('sync-overlay').classList.add('hidden');
            applyState(currentData);
        };

        function applyState(data) {
            if (!data) return;
            if (data.type === 'youtube' && ytPlayer?.seekTo) {
                ytPlayer.seekTo(data.time, true);
                if (data.status === 'playing') ytPlayer.playVideo();
                else ytPlayer.pauseVideo();
            } else {
                htmlPlayer.currentTime = data.time;
                if (data.status === 'playing') htmlPlayer.play();
                else htmlPlayer.pause();
            }
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ê–î–ú–ò–ù–ê ---
        window.startMedia = () => {
            const url = document.getElementById('mediaUrl').value;
            let type = 'html5', src = url;
            const ytMatch = url.match(/(?:youtu\.be\/|youtube\.com\/watch\?v=)([^&?#]+)/);
            if (ytMatch) { type = 'youtube'; src = ytMatch[1]; }

            set(ref(db, 'cinema/state'), { type, src, status: 'paused', time: 0 });
            document.getElementById('adminModal').classList.add('hidden');
        };

        window.stopMedia = () => remove(ref(db, 'cinema/state'));

        window.togglePlay = () => {
            const newStatus = currentData.status === 'playing' ? 'paused' : 'playing';
            let time = (currentData.type === 'youtube') ? ytPlayer.getCurrentTime() : htmlPlayer.currentTime;
            set(ref(db, 'cinema/state'), { ...currentData, status: newStatus, time: time });
        };

        // –ü–µ—Ä–µ–º–æ—Ç–∫–∞
        document.getElementById('progressBar').oninput = (e) => {
            set(ref(db, 'cinema/state'), { ...currentData, time: parseFloat(e.target.value), status: 'paused' });
        };

        setInterval(() => {
            if (isAdmin && currentData) {
                let t = (currentData.type === 'youtube') ? ytPlayer.getCurrentTime() : htmlPlayer.currentTime;
                let d = (currentData.type === 'youtube') ? ytPlayer.getDuration() : htmlPlayer.duration;
                document.getElementById('progressBar').max = d || 100;
                document.getElementById('progressBar').value = t;
                document.getElementById('timeShow').innerText = Math.floor(t/60) + ":" + String(Math.floor(t%60)).padStart(2,'0');
            }
        }, 1000);

        // --- –ß–ê–¢ ---
        window.send = () => {
            const i = document.getElementById('msgInput');
            if (i.value.trim() && myNick) {
                push(ref(db, 'chat'), { u: myNick, t: i.value.trim() });
                i.value = '';
            }
        };

        onChildAdded(ref(db, 'chat'), (s) => {
            const m = s.val();
            const d = document.createElement('div');
            d.className = `msg ${m.u === myNick ? 'own' : 'other'}`;
            d.innerHTML = `<b>${m.u}:</b> ${m.t}`;
            document.getElementById('chatBox').appendChild(d);
            document.getElementById('chatBox').scrollTop = 9999;
        });

        // --- –ú–û–î–ê–õ–ö–ò ---
        window.openAdmin = () => {
            const p = prompt("–ü–∞—Ä–æ–ª—å:");
            if (p === "2025") {
                isAdmin = true;
                localStorage.setItem('is_admin', 'true');
                document.getElementById('adminModal').classList.remove('hidden');
            }
        };
        window.closeAdmin = () => document.getElementById('adminModal').classList.add('hidden');

        if (myNick) document.getElementById('loginModal').classList.add('hidden');
    </script>
</body>
</html>

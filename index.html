<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π —á–∞—Ç üéÑ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%); min-height: 100vh; overflow-x: hidden; color: white; }
        
        /* –°–Ω–µ–≥ –∏ —á–∞—Å—Ç–∏—Ü—ã */
        .snowflake { position: fixed; top: -10px; color: #fff; pointer-events: none; z-index: 1; animation: fall linear infinite; font-size: 20px; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }

        .container { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; z-index: 10; }

        /* --- –°–ò–ù–•–†–û–ù–ù–´–ô –ü–õ–ï–ï–† --- */
        .cinema-container {
            background: #000; border: 2px solid #fcd34d; border-radius: 20px;
            overflow: hidden; margin-bottom: 20px; position: relative;
            box-shadow: 0 0 30px rgba(252, 211, 77, 0.3); display: none; /* –°–∫—Ä—ã—Ç –ø–æ–∫–∞ –Ω–µ—Ç –≤–∏–¥–µ–æ */
        }
        
        video { width: 100%; display: block; }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É —á–µ—Ä–µ–∑ JS) */
        .controls-layer {
            background: rgba(0, 0, 0, 0.7); padding: 10px; display: flex; align-items: center; gap: 10px;
        }
        .control-btn { background: none; border: none; color: #fcd34d; font-size: 20px; cursor: pointer; padding: 5px 10px; }
        .progress-bar { flex: 1; -webkit-appearance: none; height: 5px; background: #444; border-radius: 5px; outline: none; }
        .progress-bar::-webkit-slider-thumb { -webkit-appearance: none; width: 15px; height: 15px; background: #fcd34d; border-radius: 50%; cursor: pointer; }
        .time-display { font-size: 12px; font-family: monospace; min-width: 80px; text-align: center; }

        /* –ß–∞—Ç */
        .chat-container { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border-radius: 30px; border: 2px solid rgba(255, 255, 255, 0.2); overflow: hidden; height: 500px; display: flex; flex-direction: column; }
        .chat-header { padding: 15px; background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .message { margin-bottom: 10px; max-width: 80%; padding: 8px 12px; border-radius: 15px; font-size: 14px; }
        .message.own { align-self: flex-end; background: linear-gradient(135deg, #fbbf24, #f97316); }
        .message.other { align-self: flex-start; background: rgba(255,255,255,0.2); }
        
        .input-area { padding: 15px; display: flex; gap: 10px; background: rgba(0,0,0,0.2); }
        input { flex: 1; padding: 10px; border-radius: 10px; border: none; background: rgba(255,255,255,0.2); color: white; outline: none; }
        
        /* –ú–æ–¥–∞–ª–∫–∏ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #555; }
        .hidden { display: none !important; }
        .admin-panel { max-height: 80vh; overflow-y: auto; }
        .user-item { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #333; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2 style="color:#fcd34d">üéÑ –í–•–û–î –í –ß–ê–¢</h2>
            <input type="text" id="nickInput" placeholder="–ù–∏–∫–Ω–µ–π–º..." style="width:100%; margin:20px 0; padding:10px;">
            <button onclick="joinChat()" style="width:100%; padding:10px; background:#f59e0b; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div id="adminModal" class="modal hidden">
        <div class="modal-content admin-panel">
            <h3>‚öôÔ∏è –ü—É–ª—å—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
            
            <div style="background:#333; padding:10px; border-radius:10px; margin:15px 0;">
                <p style="margin-bottom:5px;">üé¨ <b>–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–∏–ª—å–º (.mp4)</b></p>
                <input type="text" id="movieUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ .mp4 —Ñ–∞–π–ª" style="width:100%; margin-bottom:10px;">
                <button onclick="loadMovie()" style="background:#10b981; border:none; padding:8px 20px; color:white; border-radius:5px; cursor:pointer;">‚ñ∂Ô∏è –ó–ê–ü–£–°–¢–ò–¢–¨ –ü–õ–ï–ï–†</button>
                <button onclick="stopMovie()" style="background:#ef4444; border:none; padding:8px 20px; color:white; border-radius:5px; cursor:pointer; margin-top:5px;">‚èπ –£–ë–†–ê–¢–¨ –≠–ö–†–ê–ù</button>
            </div>

            <div id="userList" style="text-align:left; margin-bottom:15px;"></div>
            <button onclick="closeAdmin()" style="width:100%; padding:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div class="container">
        <div id="cinema" class="cinema-container">
            <video id="mainVideo" playsinline></video>
            
            <div id="adminControls" class="controls-layer hidden">
                <button id="btnPlay" class="control-btn">‚ñ∂</button>
                <button id="btnPause" class="control-btn hidden">‚è∏</button>
                <input type="range" id="progressBar" class="progress-bar" min="0" value="0" step="0.1">
                <span id="timeDisplay" class="time-display">00:00</span>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <h3>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ß–∞—Ç</h3>
                <div>
                    <button onclick="logout()" style="background:none; border:none; font-size:20px; cursor:pointer;">üö™</button>
                    <button onclick="openAdmin()" style="background:none; border:none; font-size:20px; cursor:pointer;">‚öôÔ∏è</button>
                </div>
            </div>
            <div class="messages" id="chatBox"></div>
            <div class="input-area">
                <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button onclick="sendMsg()" style="padding:10px 20px; border:none; background:#fcd34d; border-radius:10px; cursor:pointer;">üì®</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onChildAdded, remove, onValue, set, serverTimestamp, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDOhC3fadF5gs73HgD3kkeRFE1YGgixgAA",
            authDomain: "new-year-chat.firebaseapp.com",
            databaseURL: "https://new-year-chat-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "new-year-chat",
            storageBucket: "new-year-chat.firebasestorage.app",
            messagingSenderId: "925117697794",
            appId: "1:925117697794:web:4a8a4ce97e343fead07c1b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let myNick = localStorage.getItem('chat_nick');
        const ADMIN_PASS = "2025";
        let isAdmin = localStorage.getItem('admin_access') === ADMIN_PASS;

        // --- –õ–û–ì–ò–ö–ê –°–ò–ù–•–†–û–ù–ù–û–ì–û –ü–õ–ï–ï–†–ê ---
        const video = document.getElementById('mainVideo');
        const cinemaBox = document.getElementById('cinema');
        const adminControls = document.getElementById('adminControls');
        const btnPlay = document.getElementById('btnPlay');
        const btnPause = document.getElementById('btnPause');
        const progressBar = document.getElementById('progressBar');
        const timeDisplay = document.getElementById('timeDisplay');

        // 1. –°–ª—É—à–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–ª–µ–µ—Ä–∞ –∏–∑ –±–∞–∑—ã
        onValue(ref(db, 'cinema/state'), (snap) => {
            const data = snap.val();
            if (!data) {
                cinemaBox.style.display = 'none';
                video.pause();
                video.src = "";
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–µ—Ä
            if (cinemaBox.style.display === 'none') {
                cinemaBox.style.display = 'block';
                video.src = data.url;
            }

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ (–µ—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ > 2 —Å–µ–∫—É–Ω–¥, –ø–æ–¥–≥–æ–Ω—è–µ–º)
            if (Math.abs(video.currentTime - data.time) > 2) {
                video.currentTime = data.time;
            }

            // –°—Ç–∞—Ç—É—Å
            if (data.status === 'playing') {
                video.play().catch(e => console.log("–ê–≤—Ç–æ–ø–ª–µ–π –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –±—Ä–∞—É–∑–µ—Ä–æ–º, –Ω—É–∂–Ω–æ –Ω–∞–∂–∞—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É"));
            } else {
                video.pause();
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º UI –∞–¥–º–∏–Ω–∞, –µ—Å–ª–∏ –º—ã –∞–¥–º–∏–Ω
            if (isAdmin) {
                adminControls.classList.remove('hidden');
                updateAdminUI(data.status, data.time);
            }
        });

        // 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
        if (isAdmin) {
            // –ö–ª–∏–∫ Play
            btnPlay.onclick = () => {
                set(ref(db, 'cinema/state'), {
                    status: 'playing',
                    time: video.currentTime,
                    url: video.src,
                    timestamp: Date.now()
                });
            };

            // –ö–ª–∏–∫ Pause
            btnPause.onclick = () => {
                set(ref(db, 'cinema/state'), {
                    status: 'paused',
                    time: video.currentTime,
                    url: video.src,
                    timestamp: Date.now()
                });
            };

            // –ü–µ—Ä–µ–º–æ—Ç–∫–∞ (Seek)
            progressBar.oninput = () => {
                set(ref(db, 'cinema/state'), {
                    status: 'paused', // –ü—Ä–∏ –ø–µ—Ä–µ–º–æ—Ç–∫–µ —Å—Ç–∞–≤–∏–º –ø–∞—É–∑—É
                    time: parseFloat(progressBar.value),
                    url: video.src,
                    timestamp: Date.now()
                });
            };
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –ª–æ–∫–∞–ª—å–Ω–æ –ø—Ä–∏ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–∏
        video.ontimeupdate = () => {
            if (isAdmin) {
                progressBar.max = video.duration;
                progressBar.value = video.currentTime;
                
                // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –≤ –±–∞–∑—É, —á—Ç–æ–±—ã —É –≤—Å–µ—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–æ—Å—å
                // –ù–æ –¥–µ–ª–∞–µ–º —ç—Ç–æ —Ä–µ–¥–∫–æ, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –±–∞–∑—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑ –≤ 5 —Å–µ–∫ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É)
            }
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ 00:00
            let m = Math.floor(video.currentTime / 60);
            let s = Math.floor(video.currentTime % 60);
            timeDisplay.innerText = `${m}:${s < 10 ? '0'+s : s}`;
        };

        function updateAdminUI(status, time) {
            if (status === 'playing') {
                btnPlay.classList.add('hidden');
                btnPause.classList.remove('hidden');
            } else {
                btnPlay.classList.remove('hidden');
                btnPause.classList.add('hidden');
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
        window.loadMovie = () => {
            const url = document.getElementById('movieUrl').value;
            if(url) {
                set(ref(db, 'cinema/state'), {
                    status: 'paused',
                    time: 0,
                    url: url,
                    timestamp: Date.now()
                });
            }
        };
        window.stopMovie = () => remove(ref(db, 'cinema/state'));

        // --- –û–ë–´–ß–ù–´–ô –ß–ê–¢ ---
        window.joinChat = () => {
            const nick = document.getElementById('nickInput').value.trim();
            if (!nick) return;
            myNick = nick;
            localStorage.setItem('chat_nick', nick);
            
            // –§–∏–∫—Å "–º–µ—Ä—Ç–≤—ã—Ö –¥—É—à"
            const userRef = ref(db, 'users/' + nick);
            set(userRef, { online: true });
            onDisconnect(userRef).remove();

            document.getElementById('loginModal').classList.add('hidden');
            checkAccess();
        };

        function checkAccess() {
            // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞, –¥–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é
            if (localStorage.getItem('admin_access') === ADMIN_PASS) {
                isAdmin = true;
                adminControls.classList.remove('hidden');
            }
        }

        window.sendMsg = () => {
            const i = document.getElementById('msgInput');
            if(i.value.trim()) {
                push(ref(db, 'messages'), { user: myNick, text: i.value.trim() });
                i.value = '';
            }
        };

        onChildAdded(ref(db, 'messages'), (s) => {
            const m = s.val();
            const d = document.createElement('div');
            d.className = `message ${m.user === myNick ? 'own' : 'other'}`;
            d.innerText = `${m.user}: ${m.text}`;
            document.getElementById('chatBox').appendChild(d);
            document.getElementById('chatBox').scrollTop = 9999;
        });

        // --- –ê–î–ú–ò–ù–ö–ê (–°–ü–ò–°–û–ö) ---
        window.openAdmin = () => {
            if (localStorage.getItem('admin_access') === ADMIN_PASS || prompt("Pass:") === ADMIN_PASS) {
                localStorage.setItem('admin_access', ADMIN_PASS);
                isAdmin = true;
                document.getElementById('adminModal').classList.remove('hidden');
                loadUsers();
            }
        };
        window.closeAdmin = () => document.getElementById('adminModal').classList.add('hidden');
        
        function loadUsers() {
            onValue(ref(db, 'users'), (snap) => {
                const div = document.getElementById('userList');
                div.innerHTML = '';
                snap.forEach(u => {
                    div.innerHTML += `<div class="user-item"><span>üü¢ ${u.key}</span> <button onclick="kick('${u.key}')" style="background:red;border:none;color:white;">Kick</button></div>`;
                });
            });
        }
        window.kick = (n) => set(ref(db, `users/${n}/kicked`), true);

        // –°–Ω–µ–≥
        function createSnow() {
            for(let i=0; i<30; i++){
                const s = document.createElement('div'); s.className='snowflake'; s.innerText='‚ùÑ';
                s.style.left=Math.random()*100+'%'; s.style.animationDuration=(Math.random()*5+5)+'s';
                document.body.appendChild(s);
            }
        }
        createSnow();
        if(myNick) { document.getElementById('loginModal').classList.add('hidden'); checkAccess(); }
    </script>
</body>
</html>

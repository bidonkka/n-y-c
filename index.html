<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ß–∞—Ç üéÑ</title>
    <style>
        /* –í–µ—Å—å CSS –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º, —è –æ–±–Ω–æ–≤–ª—è—é —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏–∫—É —Å–∫—Ä–∏–ø—Ç–æ–≤ –Ω–∏–∂–µ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%); min-height: 100vh; overflow-x: hidden; position: relative; }
        .snowflake { position: fixed; top: -10px; color: #fff; pointer-events: none; z-index: 1; animation: fall linear infinite; font-size: 20px; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }
        .firework-particle { position: fixed; width: 6px; height: 6px; border-radius: 50%; pointer-events: none; z-index: 9999; animation: explode 1s ease-out forwards; }
        @keyframes explode { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity: 0; } }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; z-index: 10; }
        .timer-box { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border-radius: 30px; padding: 30px; margin-bottom: 20px; border: 2px solid rgba(255, 255, 255, 0.2); text-align: center; }
        .timer { display: flex; justify-content: center; gap: 20px; }
        .time-unit { background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(250, 204, 21, 0.5); border-radius: 20px; padding: 20px; min-width: 90px; }
        .time-value { font-size: 48px; font-weight: 800; color: #fcd34d; }
        .chat-container { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border-radius: 30px; border: 2px solid rgba(255, 255, 255, 0.2); overflow: hidden; }
        .chat-header { background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(249, 115, 22, 0.3)); padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .chat-title-main { color: #ffffff !important; font-weight: 900 !important; font-size: 28px; }
        .messages { height: 400px; overflow-y: auto; padding: 20px; background: rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        .message { margin-bottom: 15px; display: flex; flex-direction: column; max-width: 75%; position: relative; }
        .message.own { align-self: flex-end; }
        .message.other { align-self: flex-start; }
        .message-content { padding: 12px 16px; border-radius: 20px; color: white; }
        .message.own .message-content { background: linear-gradient(135deg, #fbbf24, #f97316); }
        .message.other .message-content { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255,255,255,0.3); }
        .input-area { padding: 20px; display: flex; gap: 10px; }
        input { flex: 1; padding: 15px; border-radius: 15px; border: none; background: rgba(255, 255, 255, 0.2); color: white; outline: none; }
        button.action-btn { padding: 10px 25px; border-radius: 15px; border: none; background: #f59e0b; color: white; font-weight: bold; cursor: pointer; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: #1e293b; padding: 25px; border-radius: 30px; width: 95%; max-width: 450px; text-align: center; color: white; }
        .admin-scroll-area { max-height: 300px; overflow-y: auto; text-align: left; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 5px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h1 style="color:#fcd34d">üéÑ –ù–û–í–û–ì–û–î–ù–ò–ô –ß–ê–¢</h1>
            <input type="text" id="nickInput" placeholder="–í–∞—à –Ω–∏–∫..." maxlength="15" style="width: 100%; padding: 15px; border-radius: 15px; margin-top: 20px; border: none;">
            <button onclick="joinChat()" class="action-btn" style="width: 100%; margin-top: 15px;">–í–û–ô–¢–ò üéâ</button>
        </div>
    </div>

    <div id="adminModal" class="modal hidden">
        <div class="modal-content">
            <h2>‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
            <div class="admin-scroll-area">
                <div style="color:#fcd34d; font-size:12px; margin: 10px 0;">–ê–ö–¢–ò–í–ù–´–ï</div>
                <div id="activeUserList"></div>
                <div style="color:#fcd34d; font-size:12px; margin: 10px 0;">–ë–ê–ù / –ö–ò–ö</div>
                <div id="blockedUserList"></div>
            </div>
            <button onclick="adminAction('fireworks')" style="background:#8b5cf6; width:48%; padding:10px; border:none; border-radius:10px; color:white; margin-top:10px;">üéá –°–∞–ª—é—Ç</button>
            <button onclick="adminAction('clear')" style="background:#ef4444; width:48%; padding:10px; border:none; border-radius:10px; color:white;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            <button onclick="closeAdmin()" style="background:#475569; width:100%; padding:10px; border:none; border-radius:10px; color:white; margin-top:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div class="container">
        <div class="timer-box">
            <div id="timerTitle" style="color:white; margin-bottom:10px;">‚è∞ –î–û –ù–û–í–û–ì–û –ì–û–î–ê:</div>
            <div class="timer">
                <div class="time-unit"><div class="time-value" id="h">00</div></div>
                <div class="time-unit"><div class="time-value" id="m">00</div></div>
                <div class="time-unit"><div class="time-value" id="s">00</div></div>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <h3 class="chat-title-main">–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ß–∞—Ç</h3>
                <div>
                    <button style="background:none; border:none; font-size:24px; cursor:pointer;" onclick="logout()">üö™</button>
                    <button style="background:none; border:none; font-size:24px; cursor:pointer;" onclick="openAdmin()">‚öôÔ∏è</button>
                </div>
            </div>
            <div class="messages" id="chatBox"></div>
            <div class="input-area">
                <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="action-btn" onclick="sendMsg()">üì®</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onChildAdded, onChildChanged, remove, onValue, set, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDOhC3fadF5gs73HgD3kkeRFE1YGgixgAA",
            authDomain: "new-year-chat.firebaseapp.com",
            databaseURL: "https://new-year-chat-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "new-year-chat",
            storageBucket: "new-year-chat.firebasestorage.app",
            messagingSenderId: "925117697794",
            appId: "1:925117697794:web:4a8a4ce97e343fead07c1b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let myNick = localStorage.getItem('chat_nick');
        const ADMIN_PASS = "2025";

        // --- –£–õ–£–ß–®–ï–ù–ù–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
        async function enableNotifications() {
            if ("Notification" in window) {
                const permission = await Notification.requestPermission();
                if (permission === "granted") {
                    console.log("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω—ã");
                }
            }
        }

        function triggerNotify(user, text) {
            // –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –Ω–µ –≤ —Ñ–æ–∫—É—Å–µ
            if (document.hidden || !document.hasFocus()) {
                if ("Notification" in window && Notification.permission === "granted") {
                    const n = new Notification("üéÑ " + user, {
                        body: text,
                        icon: "https://cdn-icons-png.flaticon.com/512/3893/3893071.png",
                        silent: false
                    });
                    
                    // –ó–≤—É–∫
                    const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
                    audio.play().catch(() => {});

                    // –í–∏–±—Ä–∞—Ü–∏—è –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                    
                    n.onclick = () => { window.focus(); n.close(); };
                }
            }
        }

        // --- –í–•–û–î / –°–¢–ê–¢–£–° ---
        window.joinChat = () => {
            const nick = document.getElementById('nickInput').value.trim();
            if (!nick) return;
            enableNotifications(); // –ó–∞–ø—Ä–æ—Å –ø—Ä–∏ –∫–ª–∏–∫–µ
            myNick = nick;
            localStorage.setItem('chat_nick', nick);
            set(ref(db, 'users/' + nick), { lastSeen: serverTimestamp(), kicked: false });
            document.getElementById('loginModal').classList.add('hidden');
            checkStatus();
        };

        function checkStatus() {
            if (!myNick) return;
            onValue(ref(db, 'banned/' + myNick), (snap) => {
                if (snap.exists() && Date.now() < snap.val()) {
                    alert("–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã!");
                    logout();
                }
            });
            onValue(ref(db, 'users/' + myNick + '/kicked'), (snap) => {
                if (snap.val() === true) {
                    set(ref(db, 'users/' + myNick + '/kicked'), false);
                    logout();
                }
            });
        }

        window.logout = () => { localStorage.removeItem('chat_nick'); location.reload(); };

        // --- –°–û–û–ë–©–ï–ù–ò–Ø ---
        window.sendMsg = () => {
            const inp = document.getElementById('msgInput');
            if (inp.value.trim() && myNick) {
                push(ref(db, 'messages'), { user: myNick, text: inp.value.trim(), time: serverTimestamp() });
                inp.value = "";
            }
        };

        document.getElementById('msgInput').addEventListener('keydown', (e) => { if(e.key === 'Enter') sendMsg(); });

        let isInitialLoad = true;
        onChildAdded(ref(db, 'messages'), (snap) => {
            const m = snap.val();
            const div = document.createElement('div');
            div.className = `message ${m.user === myNick ? 'own' : 'other'}`;
            div.innerHTML = `<div style="font-size:10px; color:#ddd; margin-bottom:2px;">${m.user}</div><div class="message-content">${m.text}</div>`;
            document.getElementById('chatBox').appendChild(div);
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
            
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏—Å—ã–ª–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            if (!isInitialLoad && m.user !== myNick) {
                triggerNotify(m.user, m.text);
            }
        });
        
        // –û—Ç–∫–ª—é—á–∞–µ–º —Ñ–ª–∞–≥ –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
        setTimeout(() => { isInitialLoad = false; }, 2000);

        // --- –ê–î–ú–ò–ù–ö–ê ---
        window.openAdmin = () => {
            let saved = localStorage.getItem('admin_access');
            if (saved === ADMIN_PASS || prompt("–ü–∞—Ä–æ–ª—å:") === ADMIN_PASS) {
                localStorage.setItem('admin_access', ADMIN_PASS);
                document.getElementById('adminModal').classList.remove('hidden');
                updateAdminLists();
            }
        };

        function updateAdminLists() {
            onValue(ref(db, '/'), (snap) => {
                const data = snap.val() || {};
                const users = data.users || {};
                const banned = data.banned || {};
                const activeDiv = document.getElementById('activeUserList');
                const blockedDiv = document.getElementById('blockedUserList');
                activeDiv.innerHTML = ""; blockedDiv.innerHTML = "";

                Object.keys(users).forEach(name => {
                    const isBanned = banned[name] && Date.now() < banned[name];
                    const isKicked = users[name].kicked === true;
                    const item = document.createElement('div');
                    item.className = 'user-item';
                    
                    if (isBanned || isKicked) {
                        item.innerHTML = `<span>üî¥ ${name}</span><button onclick="unban('${name}')" style="background:#10b981; border:none; color:white; padding:4px 8px; border-radius:5px;">–í–µ—Ä–Ω—É—Ç—å</button>`;
                        blockedDiv.appendChild(item);
                    } else {
                        item.innerHTML = `<span>üü¢ ${name}</span><div>
                            <button onclick="kick('${name}')" style="background:orange; border:none; color:white; padding:4px 8px; border-radius:5px;">Kick</button>
                            <button onclick="banPrompt('${name}')" style="background:red; border:none; color:white; padding:4px 8px; border-radius:5px; margin-left:5px;">Ban</button>
                        </div>`;
                        activeDiv.appendChild(item);
                    }
                });
            });
        }

        window.kick = (n) => set(ref(db, `users/${n}/kicked`), true);
        window.unban = (n) => { set(ref(db, `users/${n}/kicked`), false); remove(ref(db, `banned/${n}`)); };
        window.banPrompt = (n) => {
            const m = prompt("–ú–∏–Ω—É—Ç –±–∞–Ω–∞:", "10");
            if (m) { set(ref(db, 'banned/' + n), Date.now() + (parseInt(m) * 60000)); kick(n); }
        };
        window.closeAdmin = () => document.getElementById('adminModal').classList.add('hidden');
        window.adminAction = (a) => {
            if (a === 'clear') remove(ref(db, 'messages'));
            if (a === 'fireworks') set(ref(db, 'signal/fire'), Date.now());
        };

        // --- –°–ê–õ–Æ–¢ / –°–ù–ï–ì / –¢–ê–ô–ú–ï–† ---
        let sigInit = true;
        onValue(ref(db, 'signal/fire'), () => { if(!sigInit) fire(); sigInit = false; });
        function fire() {
            const x = Math.random()*window.innerWidth, y = Math.random()*window.innerHeight;
            for(let i=0; i<30; i++) {
                const p = document.createElement('div'); p.className='firework-particle';
                p.style.left=x+'px'; p.style.top=y+'px'; p.style.backgroundColor=`hsl(${Math.random()*360},100%,50%)`;
                const a = Math.random()*Math.PI*2, d = Math.random()*150+50;
                p.style.setProperty('--dx', Math.cos(a)*d+'px'); p.style.setProperty('--dy', Math.sin(a)*d+'px');
                document.body.appendChild(p); setTimeout(()=>p.remove(), 1000);
            }
        }
        function createSnow() {
            for(let i=0; i<40; i++){
                const s = document.createElement('div'); s.className='snowflake'; s.innerText='‚ùÑ';
                s.style.left=Math.random()*100+'%'; s.style.animationDuration=(Math.random()*5+5)+'s';
                document.body.appendChild(s);
            }
        }
        setInterval(() => {
            const d = new Date(2026, 0, 1) - new Date();
            if(d > 0) {
                document.getElementById('h').innerText = Math.floor(d/3600000%24).toString().padStart(2,'0');
                document.getElementById('m').innerText = Math.floor(d/60000%60).toString().padStart(2,'0');
                document.getElementById('s').innerText = Math.floor(d/1000%60).toString().padStart(2,'0');
            }
        }, 1000);
        createSnow();
        if(myNick) { document.getElementById('loginModal').classList.add('hidden'); checkStatus(); }
    </script>
</body>
</html>
